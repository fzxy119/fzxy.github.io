---
title: 负载均衡
tags:
  - 负载均衡
categories:
  - 系统性能
date: 2022-05-14 20:24:35
---

系统性能是系统提供给用户众多性能指标的混合体，最具代表性的两个指标为吞吐量，响应时间，那么负载均衡是我们增加系统吞吐量也就是系统性能的有效手段
# 常用的负载均衡技术
## 技术
1. 基于DNS的负载均衡: 在DNS中为多个地址配置同一个名字，在查询的时候将得到其中一个，从而使客服访问不同的服务器，达到负载均衡的目的。缺点：它不能区分服务器差异，也不能反应服务器状态
2. 地址转换网关负载均衡: 支持负载均衡的地址转换网关，***可以将一个外部TCP地址映射到内部多个IP地址***，对每次TCP连接请求动态使用其中一个地址，达到负载均衡的目的
3. 协议内部支持负载均衡: 有的协议内部支持与负载均衡相关的功能，如HTTP协议中的重定向功能
4. NAT(NET Address Translation 网络地址转换) 负载均衡:***Nat将一个IP地址转换为另一个IP地址***，一般用于未注册的内部地址与合法的，已注册的IP地址进行转换，只用于解决IP地址紧张，不想让网络外部知道内部网络结构等场合下。
5. 反向代理负载均衡：正向代理服务是内部通过代理访问外部网络，通过制定代理服务，并发送请求由代理服务器发送真实请求到网络，拿到结果后返回结果给用户，那么反向代理是网络上的用户向反向代理服务器发送请求，反向代理服务器向内部服务请求结果，并最终响应给用户的代理请求。
那么内部服务可配置多个站点，由反向代理服务器，实现负载均衡的功能。
6. 混合性负载均衡: 多个集群组成，每个集群使用不同的负载均衡技术

## 方式
1. ***DNS 实现负载均衡***
2. ***硬件负载均衡***
硬件负载均衡是通过专门的硬件设备来实现负载均衡功能，类似于交换机、路由器，是一个负载均衡专用的网络设备。目前业界典型的硬件负载均衡设备有两款：F5 和 A10
3. ***软件负载均衡***
软件负载均衡，可以在普通的服务器上运行负载均衡软件，实现负载均衡功能。目前常见的有 Nginx、HAproxy、LVS

## 网络层级

|OSI 7层模型	|TCP/IP 4层模型|层|
|---|---|---|
|应用层	|应用层|7层|
|表示层	|应用层|6层|
|会话层	|应用层 HTTP、 SSH、FTP、SMTP|5层|
|传输层	|传输层 TCP/UDP(PORT)|4层|
|网络层	|网络层 IP|3层|
|数据链路层2	|数据链路层 MAC|2层|
|物理层	|数据链路层|1层|
{% asset_img 2.png %}

网络七层模型是一个标准，而非实现。网络四层模型是一个实现的应用模型。网络四层模型由七层模型简化合并而来。

{% asset_img 1.png OSI层模型 %}
### 7层负载均衡
&emsp;&emsp;七层负载均衡工作在OSI模型的应用层，应用层协议较多，常用http、radius、dns等。七层负载就可以基于这些协议来负载。这些应用层协议中会包含很多有意义的内容。比如同一个Web服务器的负载均衡，除了根据IP加端口进行负载外，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡 
### 4层负载均衡
&emsp;&emsp;所谓四层即运输层，就是基于 IP + 端口的负载均衡，四层负载均衡工作在OSI模型的传输层，由于在传输层，只有TCP/UDP协议，这两种协议中除了包含源IP、目标IP以外，还包含源端口号及目的端口号。四层负载均衡服务器在接受到客户端请求后，以后通过修改数据包的地址信息（IP+端口号）将流量转发到应用服务器

### 3层负载均衡
&emsp;&emsp;基于 IP 地址,和二层负载均衡类似，负载均衡服务器对外依然提供一个VIP（虚IP），但是集群中不同的机器采用不同的IP地址。当负载均衡服务器接受到请求之后，根据不同的负载均衡算法，通过IP将请求转发至不同的真实服务器

### 2层负载均衡
&emsp;&emsp;基于 MAC 地址,负载均衡服务器对外依然提供一个VIP（虚IP），集群中不同的机器采用相同IP地址，但是机器的MAC地址不一样。当负载均衡服务器接受到请求之后，通过改写报文的目标MAC地址的方式将请求转发到目标机器实现负载均衡
# 集群
* 高可用集群     优点：避免单节点故障，另一节点能迅速顶替工作
* 负载均衡集群   优点：提高负载，提高并发量
* 分布式存储集群  优点：极大提升存储容量，提高数据可用性，保证数据安全

# 常用负载均衡工具

## LVS
LVS（Linux Virtual Server），也就是Linux虚拟服务器, 是一个由章文嵩博士发起的自由软件项目。使用LVS技术要达到的目标是：通过LVS提供的负载均衡技术和Linux操作系统实现一个高性能、高可用的服务器群集，它具有良好可靠性、可扩展性和可操作性。从而以低廉的成本实现最优的服务性能
### LVS工作模式
+ LVS/NAT：网络地址转换
{% asset_img 4.png %}

-通过网络地址转换实现的虚拟服务器

-大并发访问时，调度器的性能成为瓶颈

+ LVS/DR：直接路由

{% asset_img 5.png %}

-直接使用路由技术实现虚拟服务器

-节点服务器需要配置VIP，注意MAC地址广播

+ LVS/TUN：IP隧道

{% asset_img 6.png %}

-通过隧道方式实现虚拟服务器


## Nginx
Nginx（发音同engine x）是一个网页服务器，它能反向代理HTTP, HTTPS, SMTP, POP3, IMAP的协议链接，以及一个负载均衡器和一个HTTP缓存。
### upstream支持的负载均衡算法
+ 轮询（默认）rr round robin 可以通过weight指定轮询的权重，权重越大，被调度的次数越多
+ ip_hash 根据每个请求IP进行调度，可以解决session的问题，不能使用weight
+ fair 可以根据请求页面的大小和加载时间长短进行调度，使用第三方的upstream_fair模块
+ url_hash 按请求的url的hash进行调度，从而使每个url定向到同一服务器，使用第三方的hash模块
### upstream支持的状态参数
+ down： 暂停对该服务器的调度
+ backup: 类似于LVS Sorry Server，当所有的非backup的服务器故障时启用
+ max_fails: 请求失败的次数，默认为1
+ fail_timeout: 在经历max_fails次失败后，暂停服务的时间
```
upstream tianyun.com {
       #ip_hash;
       server 192.168.1.5 weight=1 max_fails=2 fail_timeout=2;
       server 192.168.1.2 weight=2 max_fails=2 fail_timeout=2;
       server 192.168.1.3 max_fails=2 fail_timeout=5 down;
       server 192.168.1.4 backup;

}
location  / {
     proxy_pass  http://httpservers;
     proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
}
```
> 当使用ip_hash时，服务器状态不可使用weight和backup

> proxy_next_upstream：这个指令属于 http_proxy 模块的，指定后端返回什么样的异常响应时，使用另一个realserver
## HAProxy
HAProxy是一个使用C语言编写的自由及开放源代码软件，其提供高可用性、负载均衡，以及基于TCP和HTTP的应用程序代理。

