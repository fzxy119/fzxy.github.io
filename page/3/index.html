<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>别来无恙</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="别来无恙">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="别来无恙">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="晓">
<meta property="article:tag" content="java 软件工程 hexo 笔记 晓">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="别来无恙" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">别来无恙</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">晓</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about/me">关于</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-java/zk" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/28/java/zk/" class="article-date">
  <time class="dt-published" datetime="2022-05-28T02:29:19.000Z" itemprop="datePublished">2022-05-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/28/java/zk/">zookeeper</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ZK集群"><a href="#ZK集群" class="headerlink" title="ZK集群"></a>ZK集群</h1><h2 id="ZK相关配置"><a href="#ZK相关配置" class="headerlink" title="ZK相关配置"></a>ZK相关配置</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataDir</span>=<span class="string">/var/lib/zookeeper/data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataLogDir</span>=<span class="string">/var/lib/zookeeper/datalog</span></span><br><span class="line"></span><br><span class="line"><span class="attr">clientPort</span>=<span class="string">2181</span></span><br><span class="line"></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">5</span></span><br><span class="line"></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">maxClientCnxns</span>=<span class="string">60</span></span><br><span class="line"></span><br><span class="line"><span class="attr">peerType</span>=<span class="string">observer  #observer配置</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#dataDir目录中新增myid文件，myid配置范围1-255，端口1leader进行通信和数据同步的端口，端口2位选举投票接口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.1</span>=<span class="string">10.3.60.151:2888:3888</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.2</span>=<span class="string">10.3.60.152:2888:3888</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.3</span>=<span class="string">10.3.60.153:2888:3888</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.x</span>=<span class="string">host:port1:port2:observer #observer配置</span></span><br></pre></td></tr></table></figure>



<h2 id="ZK中Leader选举"><a href="#ZK中Leader选举" class="headerlink" title="ZK中Leader选举"></a>ZK中Leader选举</h2><p><strong>集群中节点角色</strong></p>
<table>
<thead>
<tr>
<th>角色</th>
<th>读写</th>
<th>选举</th>
<th>过半写</th>
</tr>
</thead>
<tbody><tr>
<td>Leader</td>
<td>负责客户端读写</td>
<td>参与leader选举</td>
<td>参与过半写成功</td>
</tr>
<tr>
<td>Follower</td>
<td>负责客户端读</td>
<td>参与leader选举</td>
<td>参与过半写成功</td>
</tr>
<tr>
<td>Observer</td>
<td>负责客户端读</td>
<td>不参与leader选举</td>
<td>不参与过半写成功</td>
</tr>
</tbody></table>
<blockquote>
<p>Observer 在不影响写性能的条件下，提升集群的读性能</p>
</blockquote>
<p><strong>相关属性：</strong></p>
<p>SID:服务编号，及dataDir目录下myid编号</p>
<p>ZXID：事务编号，改变zookeeper几圈状态的操作，数据节点创建及删除，数据变更，客户单建立链接，及链接失效等变更都会产生新的事务编号。一般情况先会选ZXID大的节点为Leader ,如果都一样会选择SID大的节点为Leader</p>
<p>QUORUM：过半计数器</p>
<p>EPOCH：每个leader的纪元，生成新的leader都会生成一个新的增长的纪元。</p>
<h2 id="脑裂问题"><a href="#脑裂问题" class="headerlink" title="脑裂问题"></a>脑裂问题</h2><p><strong>脑裂问题描述：</strong><br>对于一个集群，想要提高这个集群的可用性，通常会采用多机房部署，比如现在有一个由6台zkServer所组成的一个集群，部署在了两个机房：</p>
<img src="/2022/05/28/java/zk/zk1.png" class="" title="脑裂问题">

<p>&emsp;&emsp;正常情况下，此集群只会有一个Leader，那么如果机房之间的网络断了之后，两个机房内的zkServer还是可以相互通信的，如果不考虑过半机制，那么就会出现每个机房内部都将选出一个Leader。</p>
<img src="/2022/05/28/java/zk/zk2.png" class="" title="脑裂问题">

<p>&emsp;&emsp;这就相当于原本一个集群，被分成了两个集群，出现了两个”大脑”，这就是所谓的”脑裂”现象。对于这种情况，其实也可以看出来，原本应该是统一的一个集群对外提供服务的，现在变成了两个集群同时对外提供服务，如果过了一会，断了的网络突然联通了，那么此时就会出现问题了，两个集群刚刚都对外提供服务了，数据该怎么合并，数据冲突怎么解决等等问题。刚刚在说明脑裂场景时有一个前提条件就是没有考虑过半机制.所以实际上Zookeeper集群中是不会轻易出现脑裂问题的，原因在于过半机制.</p>
<img src="/2022/05/28/java/zk/zk3.png" class="" title="脑裂问题">

<p>&emsp;&emsp;zookeeper的过半机制（Quorums (法定人数) 方式）：在领导者选举的过程中，如果某台zkServer获得了超过半数的选票，则此zkServer就可以成为Leader了。举个简单的例子：如果现在集群中有5台zkServer，那么half=5/2=2，那么也就是说，领导者选举的过程中至少要有三台zkServer投了同一个zkServer，才会符合过半机制，才能选出来一个Leader。</p>
<blockquote>
<p>过半机制很好的杜绝了脑列的问题</p>
</blockquote>
<h2 id="ZK作为master选举脑裂导致数据一致性问题："><a href="#ZK作为master选举脑裂导致数据一致性问题：" class="headerlink" title="ZK作为master选举脑裂导致数据一致性问题："></a>ZK作为master选举脑裂导致数据一致性问题：</h2><p>&emsp;&emsp;kafka将数据以主题划分，并且每个主题可以有多个分片，每个分片可以有多个副本，在多个副本中需要选择出主副本和副本，有主副本完成数据的操作，副本分片完成数据同步。<br>那么当出现主副本与zk因为网络问题，导致zk认为主副本掉线，重新选举主副本，但是此时主副本没有死掉，所以导致了主副本的假死现象。<br>&emsp;&emsp;如果客户端还未完成副本列表切换，那么会导致数据写入假死的副本，而完成了切换的节点数会写入到新的主副本，那么就导致了数据不一致,<br>&emsp;&emsp;Epoch leader纪元或者版本号或者叫做leader周期，当产生新的Leader后纪元会随之增加，那么老的leader数据不会同步到新的集群范围内，通过Epoch来控制集群的数据不一致性，及通过集群状态的版本号</p>
<h2 id="过半机制"><a href="#过半机制" class="headerlink" title="过半机制:"></a>过半机制:</h2><p>&emsp;&emsp;过半机制很好的杜绝了脑列的问题,过半验证还提高了系统效率，在写操作或者投票过程中不需要所有节点都完成，只要过半就完成投票或者写操作。</p>
<p><strong>容忍度问题：容忍度为n,那么集群建议的部署节点为2N+1</strong></p>
<p>&emsp;&emsp;一般情况下我们建议集群部署的节点为奇数个节点。至于为什么最好为奇数个节点？这样是为了以最大容错服务器个数的条件下，能节省资源。比如，最大容错为2的情况下，对应的zookeeper服务数，奇数为5，而偶数为6，也就是6个zookeeper服务的情况下最多能宕掉2个服务，所以从节约资源的角度看，没必要部署6（偶数）个zookeeper服务节点</p>
<h2 id="ZK权限认证方式"><a href="#ZK权限认证方式" class="headerlink" title="ZK权限认证方式"></a>ZK权限认证方式</h2><p>ACL全称为Access Control List（访问控制列表），用于控制资源的访问权限,可以控制节点的读写操作,保证数据的安全性 。</p>
<p>ZooKeeper使用ACL来控制对其znode的防问。</p>
<p>Zookeeper ACL 权限设置分为 3 部分组成，分别是：权限模式（Scheme）、授权对象（ID）、权限信息（Permission）</p>
<p>基于scheme:id:permission的方式进行权限控制： scheme表示授权模式、id模式对应值、permission即具体的增删改权限位。</p>
<h3 id="权限模式（Scheme）"><a href="#权限模式（Scheme）" class="headerlink" title="权限模式（Scheme）"></a>权限模式（Scheme）</h3><table>
<thead>
<tr>
<th>方案</th>
<th>描述</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>world</td>
<td>开放模式，world表示全世界都可以访问（这是默认设置）</td>
<td></td>
</tr>
<tr>
<td>ip</td>
<td>ip模式，限定客户端IP防问</td>
<td></td>
</tr>
<tr>
<td>auth</td>
<td>用户密码认证模式，只有在会话中添加了认证才可以防问</td>
<td></td>
</tr>
<tr>
<td>digest</td>
<td>与auth类似，区别在于auth用明文密码，而digest 用sha-1+base64加密后的密码。在实际使用中digest 更常见。</td>
<td></td>
</tr>
<tr>
<td>super</td>
<td>管理员</td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>范围验证 范围验证就是说 ZooKeeper 可以针对一个 IP 或者一段 IP 地址授予某种权限。我们可以让一个 IP 地址为“ip：192.168.11.123”的机器对服务器上的某个数据节点具有写入的权限。或者也可以通过“ip:192.168.0.1/24”给一段 IP 地址的机器赋权。</p>
</blockquote>
<h3 id="授权对象（ID）"><a href="#授权对象（ID）" class="headerlink" title="授权对象（ID）"></a>授权对象（ID）</h3><p>授权对象就是说我们要把权限赋予谁，而对应于 4 种不同的权限模式来说，</p>
<ol>
<li><p>如果我们 选择采用 IP 方式，使用的授权对象可以是一个 IP 地址或 IP 地址段</p>
</li>
<li><p>使用 Digest 或 Super 方式，则对应于一个用户名</p>
</li>
<li><p>World 模式，是授权系统中所有的用户</p>
</li>
</ol>
<h3 id="权限信息（Permission）"><a href="#权限信息（Permission）" class="headerlink" title="权限信息（Permission）"></a>权限信息（Permission）</h3><p>权限就是指我们可以在数据节点上执行的操作种类，如下所示：在 ZooKeeper 中已经定义好的权限有 5 种：</p>
<ul>
<li>数据节点（c: create）创建权限，授予权限的对象可以在数据节点下创建子节点；</li>
<li>数据节点（w: wirte）更新权限，授予权限的对象可以更新该数据节点；</li>
<li>数据节点（r: read）读取权限，授予权限的对象可以读取该节点的内容以及子节点的列表信息；</li>
<li>数据节点（d: delete）删除权限，授予权限的对象可以删除该数据节点的子节点；</li>
<li>数据节点（a: admin）管理者权限，授予权限的对象可以对该数据节点体进行 ACL 权限设置。</li>
</ul>
<h3 id="ACL相关命令"><a href="#ACL相关命令" class="headerlink" title="ACL相关命令"></a>ACL相关命令</h3><table><thead><tr><th style="text-align:left"><div><div class="table-header"><p>命令</p></div></div></th><th style="text-align:left"><div><div class="table-header"><p>使用方式</p></div></div></th><th style="text-align:left"><div><div class="table-header"><p>描述</p></div></div></th></tr></thead><tbody><tr><td style="text-align:left"><div><div class="table-cell"><p>getAcl</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>getAcl path</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>读取ACL权限</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>setAcl</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>setAcl path acl</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>设置ACL权限</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>addauth</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>addauth scheme auth</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>添加认证用户</p></div></div></td></tr></tbody></table>

<img src="/2022/05/28/java/zk/zk4.png" class="" title="ACL相关命令">

<h3 id="跳过ACL检测"><a href="#跳过ACL检测" class="headerlink" title="跳过ACL检测"></a>跳过ACL检测</h3><p>可以通过系统参数zookeeper.skipACL=yes进行配置，默认是no,可以配置为true, 则配置过的ACL将不再进行权限检测</p>
<p>zkServer.sh</p>
<img src="/2022/05/28/java/zk/zk.png" class="" title="ACL相关命令">

<h3 id="权限扩展体系"><a href="#权限扩展体系" class="headerlink" title="权限扩展体系"></a>权限扩展体系</h3><p><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.8.0/zookeeperProgrammers.html#sc_ZooKeeperPluggableAuthentication"></a></p>
<p>1: zookeeper支持自定义权限扩展，只需要集成通用的标准接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationProvider</span> &#123;</span><br><span class="line">    String <span class="title function_">getScheme</span><span class="params">()</span>;</span><br><span class="line">    KeeperException.Code <span class="title function_">handleAuthentication</span><span class="params">(ServerCnxn cnxn, <span class="type">byte</span> authData[])</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isValid</span><span class="params">(String id)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(String id, String aclExpr)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAuthenticated</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2: 插件配置 (两种方式只有一个起作用)<br>方式1 系统变量</p>
<p>-Dzookeeeper.authProvider.X=com.f.MyAuth</p>
<p>方式2 配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">authProvider.1</span>=<span class="string">com.f.MyAuth</span></span><br><span class="line"><span class="attr">authProvider.2</span>=<span class="string">com.f.MyAuth2</span></span><br></pre></td></tr></table></figure>

<h2 id="实操ACL"><a href="#实操ACL" class="headerlink" title="实操ACL"></a>实操ACL</h2><h3 id="生成授权ID"><a href="#生成授权ID" class="headerlink" title="生成授权ID"></a>生成授权ID</h3><ul>
<li>方式一 Code<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateSuperDigest</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchAlgorithmException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sId</span> <span class="operator">=</span> DigestAuthenticationProvider.generateDigest(<span class="string">&quot;artisan:xgj&quot;</span>);</span><br><span class="line">    System.out.println(sId); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>方式二 shell命令<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n &lt;user&gt;:&lt;password&gt; | openssl dgst -binary -sha1 | openssl base64</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# echo -n artisan:xgj | openssl dgst -binary -sha1 | openssl base64</span><br><span class="line">Xe7+HMYId2eNV48821ZrcFwIqIE=</span><br><span class="line">[root@localhost bin]# </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="方式一-digest-密文授权"><a href="#方式一-digest-密文授权" class="headerlink" title="方式一 digest 密文授权"></a>方式一 digest 密文授权</h3><p>创建Node的时候 设置acl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 10] create /artisan_node artisan_value digest:artisan:Xe7+HMYId2eNV48821ZrcFwIqIE=:cdrwa</span><br><span class="line">Created /artisan_node</span><br><span class="line">[zk: localhost:2181(CONNECTED) 11] get /artisan_node  # 直接查看没有访问权限的 </span><br><span class="line">org.apache.zookeeper.KeeperException$NoAuthException: KeeperErrorCode = NoAuth for /artisan_node</span><br><span class="line">[zk: localhost:2181(CONNECTED) 12] </span><br></pre></td></tr></table></figure>
<p>创建node的时候不指定acl ,然后用setAcl 设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setAcl /artisan_node digest:artisan:Xe7+HMYId2eNV48821ZrcFwIqIE=:cdrwa</span><br></pre></td></tr></table></figure>
<p>如何才能有访问权限呢？ 因为是给artisan这个用户赋权的<br>【访问前需要添加授权信息】addauth</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 12] addauth digest artisan:xgj</span><br><span class="line">[zk: localhost:2181(CONNECTED) 13] get /artisan_node</span><br><span class="line">artisan_value</span><br><span class="line">[zk: localhost:2181(CONNECTED) 14] </span><br></pre></td></tr></table></figure>
<h3 id="方式二-auth-明文授权"><a href="#方式二-auth-明文授权" class="headerlink" title="方式二 auth 明文授权"></a>方式二 auth 明文授权</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 14] addauth digest aaa:passwddd</span><br><span class="line">[zk: localhost:2181(CONNECTED) 15] create /artisanNNN  nodeValue auth:aaa:passwddd:cdwra   # 这是aaa用户授权信息会被zk保存，可以认为当前的授权用户为aaa</span><br><span class="line">Created /artisanNNN</span><br><span class="line">[zk: localhost:2181(CONNECTED) 16] get /artisanNNN</span><br><span class="line">nodeValue</span><br><span class="line">[zk: localhost:2181(CONNECTED) 17] </span><br></pre></td></tr></table></figure>
<h3 id="方式三-IP授权模式"><a href="#方式三-IP授权模式" class="headerlink" title="方式三 IP授权模式"></a>方式三 IP授权模式</h3><p>创建时设置ip的权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create /node-ip  data  ip:192.168.11.123:cdwra</span><br></pre></td></tr></table></figure>
<p>或者创建完成以后 手工调用setAcl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setAcl /node-ip ip:192.168.11.123:cdwra</span><br></pre></td></tr></table></figure>
<h3 id="方式四-Super-超级管理员模式"><a href="#方式四-Super-超级管理员模式" class="headerlink" title="方式四 Super 超级管理员模式"></a>方式四 Super 超级管理员模式</h3><p>是一种特殊的Digest模式， 在Super模式下超级管理员用户可以对Zookeeper上的节点进行任何的操作.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dzookeeper.DigestAuthenticationProvider.superDigest=super:&lt;base64encoded(SHA1(password))</span><br></pre></td></tr></table></figure>

<img src="/2022/05/28/java/zk/zk5.png" class="">

<h2 id="Zookeeper应用场景"><a href="#Zookeeper应用场景" class="headerlink" title="Zookeeper应用场景"></a>Zookeeper应用场景</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/28/java/zk/" data-id="clpfb6uho0029toqwdphe4rfh" data-title="zookeeper" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-java/thread" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/19/java/thread/" class="article-date">
  <time class="dt-published" datetime="2022-05-19T11:51:35.000Z" itemprop="datePublished">2022-05-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tc/">技术</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/19/java/thread/">Thread</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="JAVA-Thread的状态："><a href="#JAVA-Thread的状态：" class="headerlink" title="JAVA Thread的状态："></a>JAVA Thread的状态：</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">State</span> &#123;</span><br><span class="line">       <span class="comment">//新建线程但是未进行start方法调用的线程</span></span><br><span class="line">        NEW,</span><br><span class="line">       <span class="comment">//一个正在JVM中运行的线程状态，以下两种情况都是运行状态</span></span><br><span class="line">       <span class="comment">//1：获得cpu时间分配执行状态，2:失去cpu时间分片后的就绪状态，等待系统资源的状态，如cpu处理器</span></span><br><span class="line">        RUNNABLE，</span><br><span class="line">       <span class="comment">//线程阻塞等待一个监视锁，获取锁后可再次执行</span></span><br><span class="line">       <span class="comment">// 1.如进入了synchronized 阻塞方法 </span></span><br><span class="line">       <span class="comment">// 2.在调用Object.wait后重入synchronized  </span></span><br><span class="line">            <span class="comment">//调用 wait 方法必须在同步块中，即是要先获取锁并进入同步块，这是第一次 enter</span></span><br><span class="line">            <span class="comment">//而调用 wait 之后则会释放该锁，并进入此锁的等待队列（wait set）中</span></span><br><span class="line">            <span class="comment">//当收到其它线程的 notify 或 notifyAll 通知之后，等待线程并不能立即恢复执行，因为停止的地方是在同步块内，而锁已               经释放了，所以它要重新获取锁才能再次进入（reenter）同步块，然后从上次 wait 的地方恢复执行。这是第二次 enter，               所以叫 reenter</span></span><br><span class="line">        BLOCKED,</span><br><span class="line">        <span class="comment">//线程处于等待其他线程的一个状态</span></span><br><span class="line">        	<span class="comment">//不带有等待时间的Object.wait，等待别的线程唤醒，Object.notify()，Object.notifyAll(),</span></span><br><span class="line">        	<span class="comment">//不带有时间的Thread.join，等待合并线程的执行完成</span></span><br><span class="line">    		<span class="comment">//或者LockSupport.park</span></span><br><span class="line">        WAITING，</span><br><span class="line">        <span class="comment">//线程处于有限期等待状态</span></span><br><span class="line">        <span class="comment">//带有等待时间的</span></span><br><span class="line">              <span class="comment">// Thread.sleep(long),</span></span><br><span class="line">    		 <span class="comment">// Object.wait(long),</span></span><br><span class="line">              <span class="comment">// Thread.join(long),</span></span><br><span class="line">    		 <span class="comment">// LockSupport.parkNanos,</span></span><br><span class="line">   			 <span class="comment">// LockSupport.parkUntil</span></span><br><span class="line">        TIMED_WAITING,</span><br><span class="line">        <span class="comment">//线程处于完成终止状态</span></span><br><span class="line">        TERMINATED;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="JavaThread的操作"><a href="#JavaThread的操作" class="headerlink" title="JavaThread的操作"></a>JavaThread的操作</h1><ul>
<li><p>静态方法</p>
<p>public static void sleep(long millis, int nanos) throws InterruptedException</p>
<p>如果是临界区代码段，那么线程<strong>不会释放监视器锁资源</strong></p>
</li>
<li><p>成员方法<br>public final void join() throws InterruptedException<br>public final synchronized void join(long millis, int nanos)throws InterruptedException<br>public final synchronized void join(long millis) throws InterruptedException </p>
<p>如果是临界区代码段，那么线程<strong>不会释放监视器锁资源</strong></p>
<p>public void interrupt()<br>public boolean isInterrupted() </p>
<p>对于正在执行的线程，终端操作只是将线程的终端标识设置为true，表示已中断，并不会做其他的操作，线程可在内部根据isInterrupted 来判断线程释放继续执行</p>
<p>对于阻塞的线程，终端操作会直接使线程抛出InterruptedException 异常，线程根据情况判断是否继续进行线程操作</p>
</li>
<li><p>LockSupport：<br>LockSupport.park<br>LockSupport.unpark<br>LockSupport.parkNanos,<br>LockSupport.parkUntil</p>
</li>
<li><p>Object：<br>Object.wait(long)<br>Object.wait</p>
<p>如果是临界区代码段，那么<strong>线程释放监视器锁资源</strong></p>
</li>
<li><p>Object.notify()，<br>Object.notifyAll(),</p>
<p>通知其他等待线程，锁已释放，重新竞争锁资源</p>
</li>
</ul>
<h1 id="线程创建的和使用的几种方式："><a href="#线程创建的和使用的几种方式：" class="headerlink" title="线程创建的和使用的几种方式："></a>线程创建的和使用的几种方式：</h1><h3 id="继承方式："><a href="#继承方式：" class="headerlink" title="继承方式："></a>继承方式：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">       log.info(<span class="string">&quot;线程运行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createThread</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">OThread</span> <span class="variable">ot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OThread</span>();</span><br><span class="line">	ot.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行对象方式"><a href="#执行对象方式" class="headerlink" title="执行对象方式"></a>执行对象方式</h3><p>Runnable对象可作为线程的执行对象来传递到线程内部并执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runnable</span> <span class="variable">targ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Runnable线程运行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Thread</span> <span class="variable">runTarget1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(targ);</span><br><span class="line"><span class="type">Thread</span> <span class="variable">runTarget2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(targ);</span><br><span class="line">runTarget1.start();</span><br><span class="line">runTarget2.start();</span><br></pre></td></tr></table></figure>

<h3 id="FutureTask方式"><a href="#FutureTask方式" class="headerlink" title="FutureTask方式:"></a>FutureTask方式:</h3><p>Future接口支持我们获取异步执行的结果，并可以在执行的过程中进行cancel操作，但是无法作为线程的执行对象</p>
<p>Runnable可以作为线程的执行对象，但是无法获取到执行的结果，</p>
<p>那RunnableFuture就结合了Runnable和Future接口的对两者的功能进行了融合，既可以作为Thread的执行对象也可以获取到异步执行结果，FutureTask就是RunnableFuture的实现，来作为线程执行对象，并支持获取执行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FutureTask</span> <span class="variable">fttask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;String&gt;(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;FutureTask result&quot;</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"> <span class="type">Thread</span> <span class="variable">ft</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(fttask);</span><br><span class="line"> ft.start();</span><br><span class="line">log.info(<span class="string">&quot;FutureTask:&#123;&#125;&quot;</span>,fttask.get());</span><br></pre></td></tr></table></figure>

<h3 id="线程池方式："><a href="#线程池方式：" class="headerlink" title="线程池方式："></a>线程池方式：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//单线程，无解队列线程池LinkedBlockingQueue</span></span><br><span class="line"><span class="comment">//队列无线，当任务无线大时会导致内存溢出，RejectedExecutionHandler</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorServiceSingleThreadExecutor</span> <span class="operator">=</span>  Executors.newSingleThreadExecutor();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//无限线程容量,SynchronousQueue队列，RejectedExecutionHandler</span></span><br><span class="line"><span class="comment">//对线程没有限制，有keepAliveTime60秒</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorServiceCachedThreadPool</span> <span class="operator">=</span>  Executors.newCachedThreadPool();</span><br><span class="line"><span class="comment">//固定数量线程，无界队列线程池LinkedBlockingQueue</span></span><br><span class="line"><span class="comment">//队列无线，当任务无线大时会导致内存溢出，RejectedExecutionHandler</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorServiceFixedThreadPool</span> <span class="operator">=</span>  Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"><span class="comment">//计划任务线程池 DelayedWorkQueue优先级队列</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorServiceScheduledThreadPool</span> <span class="operator">=</span>  Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line"><span class="comment">//抢占式线程池</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorWorkStealingPool</span> <span class="operator">=</span>  Executors.newWorkStealingPool();</span><br><span class="line"></span><br><span class="line">Future&lt;String&gt; poolF = executorServiceSingleThreadExecutor.submit(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;executorServiceSingleThreadExecutor&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">log.info(<span class="string">&quot;executorServiceSingleThreadExecutor:&#123;&#125;&quot;</span>, poolF.get());</span><br></pre></td></tr></table></figure>



<h1 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h1><p>synchronized 内置锁</p>
<ol>
<li>无锁</li>
<li>偏向锁,threadid</li>
<li>轻量级自旋锁,cas,</li>
<li>重量级锁 cxq,entrylist,waiteset,monitor</li>
</ol>
<p>原子性操作：</p>
<ol>
<li>unsafe cas volatile</li>
<li>cas 优化 LongAddr 分段锁</li>
</ol>
<p>可见性与有序性：volatile</p>
<p>as-is-Serial 保障单内核指令重排序后执行结果的正确性原则，不能保证多内核以及夸cpu指令重排序之后的执行结果正确性</p>
<p>内存屏障     保障多核指令重排序之后程序结果正确性方法</p>
<h1 id="JMM"><a href="#JMM" class="headerlink" title="JMM"></a>JMM</h1><p> 内存模型</p>
<p>  对象的创建</p>
<p>  堆内存分配 指针碰撞(Serial,ParNew)，空闲列表(CMS)</p>
<p>  内存分配线程并发  同步锁，TLAB</p>
<p>  对象引用：直接指针，引用句柄</p>
<p>内存溢出：堆溢出 元数据区溢出，栈溢出 直接内存溢出</p>
<h1 id="垃圾收集器及内存分配策略"><a href="#垃圾收集器及内存分配策略" class="headerlink" title="垃圾收集器及内存分配策略"></a>垃圾收集器及内存分配策略</h1><p>哪些内存需要回收</p>
<ol>
<li>   哪些区域需要回收？（堆，元数据区），（方法栈 本地方法栈 程序计数器）</li>
<li>   哪些对象需要回收？</li>
</ol>
<ul>
<li>​        对象已死么？引用计数法，可达性分析法</li>
<li>​        可达性分析法</li>
</ul>
<p>​    对象已死么-GCRoot条件：</p>
<ul>
<li><p>​        虚拟机栈中引用的变量（栈帧中的本地变量）</p>
</li>
<li><p>​        元数据区中静态属性引用的对象</p>
</li>
<li><p>​        元数据区中常量引用的对象</p>
</li>
<li><p>​        本地方法栈JNI（native方法）引用的对象</p>
<p> 对象已死么-可达性分析法-引用：</p>
</li>
<li><p>​        强引用</p>
</li>
<li><p>​        软引用</p>
</li>
<li><p>​        弱引用</p>
</li>
<li><p>​        虚引用</p>
</li>
</ul>
<p>​    对象已死么-是否对象已死</p>
<ul>
<li>​        两次标记</li>
<li>​        逃脱死亡的最后机会finalize</li>
</ul>
<p>​    回收元数据区：-Xnoclassgc</p>
<p>垃圾回收算法：</p>
<p>​            标记清除算法</p>
<p>​            复制算法</p>
<p>​            标记整理算法</p>
<p>什么时候回收</p>
<p>​    枚举根节点：</p>
<p>​               类加载完成的时候对象内通过Oopmap数据结构记录引用信息,gc过程中直接遍历oopmap结构，解决因堆和元数据区内存比较大，导致root节点遍历时间过长。</p>
<p>​     安全点：因为root节点的对象包含线程运行栈</p>
<p>​     安全区域：修改oopmap结构的区域</p>
<p>​    </p>
<h1 id="AbstractQueuedSynchronizer"><a href="#AbstractQueuedSynchronizer" class="headerlink" title="AbstractQueuedSynchronizer"></a>AbstractQueuedSynchronizer</h1><p>模板方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> private transient volatile Node head;</span><br><span class="line"> private transient volatile Node tail;</span><br><span class="line"> private volatile int state;</span><br><span class="line"></span><br><span class="line">public final void acquire(int arg)</span><br><span class="line">public final boolean tryAcquireNanos(int arg, long nanosTimeout)throws InterruptedException</span><br><span class="line">public final void acquireInterruptibly(int arg)throws InterruptedException</span><br><span class="line">public final boolean release(int arg) </span><br><span class="line"></span><br><span class="line">public final void acquireShared(int arg)</span><br><span class="line">public final boolean tryAcquireSharedNanos(int arg, long nanosTimeout)throws InterruptedException</span><br><span class="line">public final void acquireSharedInterruptibly(int arg)throws InterruptedException </span><br><span class="line">public final boolean releaseShared(int arg) </span><br><span class="line"></span><br><span class="line">protected boolean tryAcquire(int arg)</span><br><span class="line">protected boolean tryRelease(int arg)</span><br><span class="line">protected int tryAcquireShared(int arg)</span><br><span class="line">protected boolean tryReleaseShared(int arg)</span><br><span class="line"></span><br></pre></td></tr></table></figure>







      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/19/java/thread/" data-id="clpfb6uhj001mtoqwcapw3g81" data-title="Thread" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-spring/seataat" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/19/spring/seataat/" class="article-date">
  <time class="dt-published" datetime="2022-05-19T11:49:31.000Z" itemprop="datePublished">2022-05-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringCloud/">SpringCloud</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/19/spring/seataat/">Seata-AT</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="AT模式两阶段提交"><a href="#AT模式两阶段提交" class="headerlink" title="AT模式两阶段提交"></a>AT模式两阶段提交</h2><ul>
<li>基于支持本地 ACID 事务的关系型数据库。</li>
<li>Java 应用，通过 JDBC 访问数据库。</li>
</ul>
<p>两阶段提交协议的演变：</p>
<ul>
<li>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。</li>
<li>二阶段：<ul>
<li>提交异步化，非常快速地完成。</li>
<li>回滚通过一阶段的回滚日志进行反向补偿。</li>
</ul>
</li>
</ul>
<p>隔离级别：全局事务隔离级别为读未提交</p>
<h2 id="如何解决脏读脏写"><a href="#如何解决脏读脏写" class="headerlink" title="如何解决脏读脏写:"></a>如何解决脏读脏写:</h2><p>1：脏写因为出现在分支事务中，可使用<code>@GlobalTransactional</code> 升级分支事务请求全局事务锁，来解决脏写问题。</p>
<p>2：脏写因为出现在分支事务中，可使用<code>@GlobalLock + select for update</code> 升级分支事务请求全局事务锁，来解决脏写问题。</p>
<p>3：脏读因为全局事务有可能回滚，导致事务外查询数据会读取到脏数据，可使用<code>@GlobalLock + select for update</code> 升级分支事务请求全局事务锁，来解决脏读问题。</p>
<p><strong>允许空回滚：</strong></p>
<p>事务协调器在调用TCC服务的一阶段Try操作时，可能会出现因为丢包而导致的网络超时，此时事务协调器会触发二阶段回滚，调用TCC服务的Cancel操作；</p>
<p>TCC服务在未收到Try请求的情况下收到Cancel请求，这种场景被称为空回滚；TCC服务在实现时应当允许空回滚的执行；</p>
<p><strong>防悬挂控制:</strong></p>
<p>事务协调器在调用TCC服务的一阶段Try操作时，可能会出现因网络拥堵而导致的超时，此时事务协调器会触发二阶段回滚，调用TCC服务的Cancel操作；在此之后，拥堵在网络上的一阶段Try数据包被TCC服务收到，出现了二阶段Cancel请求比一阶段Try请求先执行的情况；</p>
<p>用户在实现TCC服务时，应当允许空回滚，但是要拒绝执行空回滚之后到来的一阶段Try请求。</p>
<p><strong>幂等控制</strong>:<br>        无论是网络数据包重传，还是异常事务的补偿执行，都会导致TCC服务的Try、Confirm或者Cancel操作被重复执行；用户在实现TCC服务时，需要考虑幂等控制，即Try、Confirm、Cancel 执行次和执行多次的业务结果是一样的</p>
<p><strong>业务数据可见性控制:</strong></p>
<p>TCC服务的一阶段Try操作会做资源的预留，在二阶段操作执行之前，如果其他事务需要读取被预留的资源数据，那么处于中间状态的业务数据该如何向用户展示，需要业务在实现时考虑清楚；通常的设计原则是“宁可不展示、少展示，也不多展示、错展示”</p>
<p><strong>业务数据并发访问控制:</strong><br>        TCC服务的一阶段Try操作预留资源之后，在二阶段操作执行之前，预留的资源都不会被释放；如果此时其他分布式事务修改这些业务资源，会出现分布式事务的并发问题；</p>
<p>用户在实现TCC服务时，需要考虑业务数据的并发控制，尽量将逻辑锁粒度降到最低，以最大限度的提高分布式事务的并发性</p>
<h2 id="全局事务锁"><a href="#全局事务锁" class="headerlink" title="全局事务锁"></a>全局事务锁</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//io.seata.rm.datasource.exec.BaseTransactionalExecutor类</span></span><br><span class="line"><span class="comment">//全局锁key构建 及锁请求检查</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareUndoLog</span><span class="params">(TableRecords beforeImage, TableRecords afterImage)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">if</span> (beforeImage.getRows().isEmpty() &amp;&amp; afterImage.getRows().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ConnectionProxy</span> <span class="variable">connectionProxy</span> <span class="operator">=</span> statementProxy.getConnectionProxy();</span><br><span class="line">        <span class="type">TableRecords</span> <span class="variable">lockKeyRecords</span> <span class="operator">=</span> sqlRecognizer.getSQLType() == SQLType.DELETE ? beforeImage : afterImage;</span><br><span class="line">    	<span class="comment">//构建全局事务锁key</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKeys</span> <span class="operator">=</span> buildLockKey(lockKeyRecords);</span><br><span class="line">        connectionProxy.appendLockKey(lockKeys);</span><br><span class="line">        <span class="type">SQLUndoLog</span> <span class="variable">sqlUndoLog</span> <span class="operator">=</span> buildUndoItem(beforeImage, afterImage);</span><br><span class="line">        connectionProxy.appendUndoLog(sqlUndoLog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//io.seata.rm.datasource.exec.SelectForUpdateExecutor</span></span><br><span class="line"><span class="comment">//全局锁key构建 及锁请求检查</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">doExecute</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    <span class="comment">// Try to get global lock of those rows selected</span></span><br><span class="line">    <span class="type">TableRecords</span> <span class="variable">selectPKRows</span> <span class="operator">=</span> buildTableRecords(getTableMeta(), selectPKSQL, paramAppenderList);</span><br><span class="line">    <span class="comment">//构建全局事务锁key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKeys</span> <span class="operator">=</span> buildLockKey(selectPKRows);</span><br><span class="line">    <span class="keyword">if</span> (RootContext.inGlobalTransaction()) &#123;</span><br><span class="line">        <span class="comment">//do as usual</span></span><br><span class="line">        statementProxy.getConnectionProxy().checkLock(lockKeys);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RootContext.requireGlobalLock()) &#123;</span><br><span class="line">        <span class="comment">//check lock key before commit just like DML to avoid reentrant lock problem(no xid thus ca</span></span><br><span class="line">        <span class="comment">// not reentrant)</span></span><br><span class="line">        statementProxy.getConnectionProxy().appendLockKey(lockKeys);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unknown situation!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//io.seata.rm.datasource.ConnectionProxy类</span></span><br><span class="line"><span class="comment">//提交前注册分支并申请及检查全局锁</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doCommit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (context.inGlobalTransaction()) &#123;</span><br><span class="line">        <span class="comment">//@GlobalTransaction</span></span><br><span class="line">        processGlobalTransactionCommit();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context.isGlobalLockRequire()) &#123;</span><br><span class="line">        <span class="comment">//@GlobalLocks</span></span><br><span class="line">        processLocalCommitWithGlobalLocks();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        targetConnection.commit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//@GlobalTransaction</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processGlobalTransactionCommit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">                <span class="comment">//注册分支并获取全局锁</span></span><br><span class="line">                register();</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">     <span class="comment">//@GlobalLocks</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processLocalCommitWithGlobalLocks</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            checkLock(context.buildLockKeys());</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//事务分支注册并获取全局锁</span></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">()</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">         ...	</span><br><span class="line">            <span class="type">Long</span> <span class="variable">branchId</span> <span class="operator">=</span> 				       DefaultResourceManager.get().branchRegister(BranchType.AT,getDataSourceProxy().getResourceId(),</span><br><span class="line">                <span class="literal">null</span>, context.getXid(), <span class="literal">null</span>, context.buildLockKeys());</span><br><span class="line">		...</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//全局锁检查</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkLock</span><span class="params">(String lockKeys)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">// Just check lock without requiring lock by now.</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">lockable</span> <span class="operator">=</span> DefaultResourceManager.get().lockQuery(BranchType.AT,</span><br><span class="line">                getDataSourceProxy().getResourceId(), context.getXid(), lockKeys);</span><br><span class="line">            <span class="keyword">if</span> (!lockable) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LockConflictException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://seata.io/zh-cn/blog/seata-tcc.html">深度剖析 Seata TCC 模式（一）</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/19/spring/seataat/" data-id="clpfb6uhs002stoqwgpfj1sgo" data-title="Seata-AT" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Seata/" rel="tag">Seata</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-spring/seata" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/19/spring/seata/" class="article-date">
  <time class="dt-published" datetime="2022-05-19T11:47:29.000Z" itemprop="datePublished">2022-05-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringCloud/">SpringCloud</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/19/spring/seata/">Seata安装</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案,</p>
<h2 id="一-Seata术语"><a href="#一-Seata术语" class="headerlink" title="一:Seata术语"></a>一:Seata术语</h2><h4 id="TC-Transaction-Coordinator-事务协调者"><a href="#TC-Transaction-Coordinator-事务协调者" class="headerlink" title="TC (Transaction Coordinator) - 事务协调者"></a>TC (Transaction Coordinator) - 事务协调者</h4><p>维护全局和分支事务的状态，驱动全局事务提交或回滚。</p>
<h4 id="TM-Transaction-Manager-事务管理器"><a href="#TM-Transaction-Manager-事务管理器" class="headerlink" title="TM (Transaction Manager) - 事务管理器"></a>TM (Transaction Manager) - 事务管理器</h4><p>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</p>
<h4 id="RM-Resource-Manager-资源管理器"><a href="#RM-Resource-Manager-资源管理器" class="headerlink" title="RM (Resource Manager) - 资源管理器"></a>RM (Resource Manager) - 资源管理器</h4><p>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p>
<h2 id="二：资源介绍"><a href="#二：资源介绍" class="headerlink" title="二：资源介绍"></a>二：资源介绍</h2><p>Seata分TC、TM和RM三个角色，TC（Server端）为单独服务端部署，TM和RM（Client端）由业务系统集成。</p>
<h4 id="client"><a href="#client" class="headerlink" title="client"></a>client</h4><p>存放client端sql脚本 (包含 <strong>undo_log</strong>表) </p>
<h4 id="config-center"><a href="#config-center" class="headerlink" title="config-center"></a>config-center</h4><p>各个配置中心参数导入脚本，<strong>config.txt</strong>(包含server和client，原名nacos-config.txt)为通用参数文件</p>
<h4 id="server"><a href="#server" class="headerlink" title="server"></a>server</h4><p>server端数据库脚本 (<strong>包含 lock_table、branch_table  global_table 与 distributed_lock</strong>) 及各个容器配置</p>
<h2 id="三：Server安装："><a href="#三：Server安装：" class="headerlink" title="三：Server安装："></a>三：Server安装：</h2><p>Server端存储模式（store.mode）现有file、db、redis三种（后续将引入raft,mongodb），</p>
<p>file模式无需改动，直接启动即可，注： file模式为单机模式，全局事务会话信息内存中读写并持久化本地文件root.data，性能较高;</p>
<p>db模式为高可用模式，全局事务会话信息通过db共享，相应性能差些;</p>
<p>redis模式Seata-Server 1.3及以上版本支持,性能较高,存在事务信息丢失风险,请提前配置合适当前场景的redis持久化配置.</p>
<h3 id="文件配置方式"><a href="#文件配置方式" class="headerlink" title="文件配置方式"></a>文件配置方式</h3><h4 id="文件模式"><a href="#文件模式" class="headerlink" title="文件模式"></a>文件模式</h4><h5 id="file-config-配置存储模式"><a href="#file-config-配置存储模式" class="headerlink" title="file.config 配置存储模式"></a>file.config 配置存储模式</h5><p>此处配置了全局事务以何种方式来存储，配置mode = “db” 支持 file db redis</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">store <span class="punctuation">&#123;</span></span><br><span class="line">  ## store mode<span class="punctuation">:</span> file、db、redis</span><br><span class="line">  mode = <span class="string">&quot;db&quot;</span></span><br><span class="line">  ## rsa decryption public key</span><br><span class="line">  publicKey = <span class="string">&quot;&quot;</span></span><br><span class="line">  ## file store property</span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    ## store location dir</span><br><span class="line">    dir = <span class="string">&quot;sessionStore&quot;</span></span><br><span class="line">    # branch session size <span class="punctuation">,</span> if exceeded first try compress lockkey<span class="punctuation">,</span> still exceeded throws exceptions</span><br><span class="line">    maxBranchSessionSize = <span class="number">16384</span></span><br><span class="line">    # globe session size <span class="punctuation">,</span> if exceeded throws exceptions</span><br><span class="line">    maxGlobalSessionSize = <span class="number">512</span></span><br><span class="line">    # file buffer size <span class="punctuation">,</span> if exceeded allocate new buffer</span><br><span class="line">    fileWriteBufferCacheSize = <span class="number">16384</span></span><br><span class="line">    # when recover batch read size</span><br><span class="line">    sessionReloadReadSize = <span class="number">100</span></span><br><span class="line">    # async<span class="punctuation">,</span> sync</span><br><span class="line">    flushDiskMode = async</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">  ## database store property</span><br><span class="line">  db <span class="punctuation">&#123;</span></span><br><span class="line">    ## the implement of javax.sql.DataSource<span class="punctuation">,</span> such as DruidDataSource(druid)/BasicDataSource(dbcp)/HikariDataSource(hikari) etc.</span><br><span class="line">    datasource = <span class="string">&quot;druid&quot;</span></span><br><span class="line">    ## mysql/oracle/postgresql/h2/oceanbase etc.</span><br><span class="line">    dbType = <span class="string">&quot;mysql&quot;</span></span><br><span class="line">    driverClassName = <span class="string">&quot;com.mysql.jdbc.Driver&quot;</span></span><br><span class="line">    ## if using mysql to store the data<span class="punctuation">,</span> recommend add rewriteBatchedStatements=<span class="literal"><span class="keyword">true</span></span> in jdbc connection param</span><br><span class="line">    url = <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/seata?rewriteBatchedStatements=true&quot;</span></span><br><span class="line">    user = <span class="string">&quot;root&quot;</span></span><br><span class="line">    password = <span class="string">&quot;CHENxiao1989119&quot;</span></span><br><span class="line">    minConn = <span class="number">5</span></span><br><span class="line">    maxConn = <span class="number">100</span></span><br><span class="line">    globalTable = <span class="string">&quot;global_table&quot;</span></span><br><span class="line">    branchTable = <span class="string">&quot;branch_table&quot;</span></span><br><span class="line">    lockTable = <span class="string">&quot;lock_table&quot;</span></span><br><span class="line">    queryLimit = <span class="number">100</span></span><br><span class="line">    maxWait = <span class="number">5000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">  ## redis store property</span><br><span class="line">  redis <span class="punctuation">&#123;</span></span><br><span class="line">    ## redis mode<span class="punctuation">:</span> single、sentinel</span><br><span class="line">    mode = <span class="string">&quot;single&quot;</span></span><br><span class="line">    ## single mode property</span><br><span class="line">    single <span class="punctuation">&#123;</span></span><br><span class="line">      host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">      port = <span class="string">&quot;6379&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    ## sentinel mode property</span><br><span class="line">    sentinel <span class="punctuation">&#123;</span></span><br><span class="line">      masterName = <span class="string">&quot;&quot;</span></span><br><span class="line">      ## such as <span class="string">&quot;10.28.235.65:26379,10.28.235.65:26380,10.28.235.65:26381&quot;</span></span><br><span class="line">      sentinelHosts = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    password = <span class="string">&quot;&quot;</span></span><br><span class="line">    database = <span class="string">&quot;0&quot;</span></span><br><span class="line">    minConn = <span class="number">1</span></span><br><span class="line">    maxConn = <span class="number">10</span></span><br><span class="line">    maxTotal = <span class="number">100</span></span><br><span class="line">    queryLimit = <span class="number">100</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="registry-conf-注册及配置中心"><a href="#registry-conf-注册及配置中心" class="headerlink" title="registry.conf 注册及配置中心"></a>registry.conf 注册及配置中心</h5><p>此处配置seata的配置中心使用何种方式，及集群模式下的seata服务如何注册服务</p>
<h4 id="使用nacos作为配置中心及服务治理中心"><a href="#使用nacos作为配置中心及服务治理中心" class="headerlink" title="使用nacos作为配置中心及服务治理中心"></a>使用nacos作为配置中心及服务治理中心</h4><p>注册中心type = “nacos”，seata服务将seataServer注册到注册中心</p>
<p>配置中心type = “nacos”   seata服务将从nacos取得seata服务的配置信息，当采用file模式，将从file.conf文件中获取配置</p>
<p>seata服务配置项可从config.txt,中获取，并上传至配置中心</p>
<p>（1）下载config.txt,并自行对应的脚本nacos-config.sh 会到上层目录查找config.txt</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sh /d/softw/seata/seata-server-1.4.2/conf/nacos-config.sh -h localhost -p 8848 -g SEATA_GROUP -t 7dba3cc6-3805-4f3d-b89c-0519044013b7 -u username -w password</span><br><span class="line">-h -- nacos ip</span><br><span class="line">-p -- nacos 端口</span><br><span class="line">-g -- seata-server配置文件 分组名</span><br><span class="line">-t -- seata-server配置文件 命名空间ID</span><br><span class="line">-u -- nacos账号</span><br><span class="line">-w -- nacos密码</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>（2）server可使用dataId = “seataServer.properties” cleant端使用上传配置 并拷贝参数到nacos</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nacos <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:8848&quot;</span></span><br><span class="line">    namespace = <span class="string">&quot;7dba3cc6-3805-4f3d-b89c-0519044013b7&quot;</span></span><br><span class="line">    group = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">    username = <span class="string">&quot;&quot;</span></span><br><span class="line">    password = <span class="string">&quot;&quot;</span></span><br><span class="line">    #可指定dataId</span><br><span class="line">    dataId = <span class="string">&quot;seataServer.properties&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="DBScript脚本"><a href="#DBScript脚本" class="headerlink" title="DBScript脚本"></a>DBScript脚本</h3><h4 id="Server端-MYSQL"><a href="#Server端-MYSQL" class="headerlink" title="Server端 MYSQL"></a>Server端 MYSQL</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------</span></span><br><span class="line"><span class="comment">-- the table to store GlobalSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `global_table`</span><br><span class="line">(</span><br><span class="line">    `xid`                       <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `transaction_id`            <span class="type">BIGINT</span>,</span><br><span class="line">    `status`                    TINYINT      <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `application_id`            <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `transaction_service_group` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `transaction_name`          <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">    `timeout`                   <span class="type">INT</span>,</span><br><span class="line">    `begin_time`                <span class="type">BIGINT</span>,</span><br><span class="line">    `application_data`          <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    `gmt_create`                DATETIME,</span><br><span class="line">    `gmt_modified`              DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`xid`),</span><br><span class="line">    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),</span><br><span class="line">    KEY `idx_transaction_id` (`transaction_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store BranchSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `branch_table`</span><br><span class="line">(</span><br><span class="line">    `branch_id`         <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `xid`               <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `transaction_id`    <span class="type">BIGINT</span>,</span><br><span class="line">    `resource_group_id` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `resource_id`       <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    `branch_type`       <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">    `status`            TINYINT,</span><br><span class="line">    `client_id`         <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    `application_data`  <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    `gmt_create`        DATETIME(<span class="number">6</span>),</span><br><span class="line">    `gmt_modified`      DATETIME(<span class="number">6</span>),</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`branch_id`),</span><br><span class="line">    KEY `idx_xid` (`xid`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store lock data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `lock_table`</span><br><span class="line">(</span><br><span class="line">    `row_key`        <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `xid`            <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">    `transaction_id` <span class="type">BIGINT</span>,</span><br><span class="line">    `branch_id`      <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `resource_id`    <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    `table_name`     <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `pk`             <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    `status`         TINYINT      <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;0:locked ,1:rollbacking&#x27;</span>,</span><br><span class="line">    `gmt_create`     DATETIME,</span><br><span class="line">    `gmt_modified`   DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`row_key`),</span><br><span class="line">    KEY `idx_status` (`status`),</span><br><span class="line">    KEY `idx_branch_id` (`branch_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `distributed_lock`</span><br><span class="line">(</span><br><span class="line">    `lock_key`       <span class="type">CHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `lock_value`     <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `expire`         <span class="type">BIGINT</span>,</span><br><span class="line">    <span class="keyword">primary</span> key (`lock_key`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;AsyncCommitting&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;RetryCommitting&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;RetryRollbacking&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;TxTimeoutCheck&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Client端sql"><a href="#Client端sql" class="headerlink" title="Client端sql"></a>Client端sql</h4><h5 id="AT模式-MYSQL-AT模式支持的数据库有：MySQL、Oracle、PostgreSQL、-TiDB、MariaDB。"><a href="#AT模式-MYSQL-AT模式支持的数据库有：MySQL、Oracle、PostgreSQL、-TiDB、MariaDB。" class="headerlink" title="AT模式 MYSQL AT模式支持的数据库有：MySQL、Oracle、PostgreSQL、 TiDB、MariaDB。"></a>AT模式 MYSQL AT模式支持的数据库有：MySQL、Oracle、PostgreSQL、 TiDB、MariaDB。</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 注意此处0.7.0+ 增加字段 context</span></span><br><span class="line"><span class="comment">-- for AT mode you must to init this sql for you business database. the seata server not need it.</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `undo_log`</span><br><span class="line">(</span><br><span class="line">    `branch_id`     <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;branch transaction id&#x27;</span>,</span><br><span class="line">    `xid`           <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;global transaction id&#x27;</span>,</span><br><span class="line">    `context`       <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;undo_log context,such as serialization&#x27;</span>,</span><br><span class="line">    `rollback_info` LONGBLOB     <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;rollback info&#x27;</span>,</span><br><span class="line">    `log_status`    <span class="type">INT</span>(<span class="number">11</span>)      <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;0:normal status,1:defense status&#x27;</span>,</span><br><span class="line">    `log_created`   DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;create datetime&#x27;</span>,</span><br><span class="line">    `log_modified`  DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;modify datetime&#x27;</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`, `branch_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  AUTO_INCREMENT <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8 COMMENT <span class="operator">=</span><span class="string">&#x27;AT transaction mode undo table&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h5 id="SAGE模式-MYSQL-Saga模式不依赖数据源。"><a href="#SAGE模式-MYSQL-Saga模式不依赖数据源。" class="headerlink" title="SAGE模式 MYSQL Saga模式不依赖数据源。"></a>SAGE模式 MYSQL Saga模式不依赖数据源。</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------------------------------- The script used for sage  --------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `seata_state_machine_def`</span><br><span class="line">(</span><br><span class="line">    `id`               <span class="type">VARCHAR</span>(<span class="number">32</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">    `name`             <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">    `tenant_id`        <span class="type">VARCHAR</span>(<span class="number">32</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tenant id&#x27;</span>,</span><br><span class="line">    `app_name`         <span class="type">VARCHAR</span>(<span class="number">32</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;application name&#x27;</span>,</span><br><span class="line">    `type`             <span class="type">VARCHAR</span>(<span class="number">20</span>)  COMMENT <span class="string">&#x27;state language type&#x27;</span>,</span><br><span class="line">    `comment_`         <span class="type">VARCHAR</span>(<span class="number">255</span>) COMMENT <span class="string">&#x27;comment&#x27;</span>,</span><br><span class="line">    `ver`              <span class="type">VARCHAR</span>(<span class="number">16</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">    `gmt_create`       DATETIME(<span class="number">3</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;create time&#x27;</span>,</span><br><span class="line">    `status`           <span class="type">VARCHAR</span>(<span class="number">2</span>)   <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;status(AC:active|IN:inactive)&#x27;</span>,</span><br><span class="line">    `content`          TEXT COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">    `recover_strategy` <span class="type">VARCHAR</span>(<span class="number">16</span>) COMMENT <span class="string">&#x27;transaction recover strategy(compensate|retry)&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `seata_state_machine_inst`</span><br><span class="line">(</span><br><span class="line">    `id`                  <span class="type">VARCHAR</span>(<span class="number">128</span>)            <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">    `machine_id`          <span class="type">VARCHAR</span>(<span class="number">32</span>)             <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;state machine definition id&#x27;</span>,</span><br><span class="line">    `tenant_id`           <span class="type">VARCHAR</span>(<span class="number">32</span>)             <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tenant id&#x27;</span>,</span><br><span class="line">    `parent_id`           <span class="type">VARCHAR</span>(<span class="number">128</span>) COMMENT <span class="string">&#x27;parent id&#x27;</span>,</span><br><span class="line">    `gmt_started`         DATETIME(<span class="number">3</span>)             <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;start time&#x27;</span>,</span><br><span class="line">    `business_key`        <span class="type">VARCHAR</span>(<span class="number">48</span>) COMMENT <span class="string">&#x27;business key&#x27;</span>,</span><br><span class="line">    `start_params`        TEXT COMMENT <span class="string">&#x27;start parameters&#x27;</span>,</span><br><span class="line">    `gmt_end`             DATETIME(<span class="number">3</span>) COMMENT <span class="string">&#x27;end time&#x27;</span>,</span><br><span class="line">    `excep`               <span class="type">BLOB</span> COMMENT <span class="string">&#x27;exception&#x27;</span>,</span><br><span class="line">    `end_params`          TEXT COMMENT <span class="string">&#x27;end parameters&#x27;</span>,</span><br><span class="line">    `status`              <span class="type">VARCHAR</span>(<span class="number">2</span>) COMMENT <span class="string">&#x27;status(SU succeed|FA failed|UN unknown|SK skipped|RU running)&#x27;</span>,</span><br><span class="line">    `compensation_status` <span class="type">VARCHAR</span>(<span class="number">2</span>) COMMENT <span class="string">&#x27;compensation status(SU succeed|FA failed|UN unknown|SK skipped|RU running)&#x27;</span>,</span><br><span class="line">    `is_running`          TINYINT(<span class="number">1</span>) COMMENT <span class="string">&#x27;is running(0 no|1 yes)&#x27;</span>,</span><br><span class="line">    `gmt_updated`         DATETIME(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `unikey_buz_tenant` (`business_key`, `tenant_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `seata_state_inst`</span><br><span class="line">(</span><br><span class="line">    `id`                       <span class="type">VARCHAR</span>(<span class="number">48</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">    `machine_inst_id`          <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;state machine instance id&#x27;</span>,</span><br><span class="line">    `name`                     <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;state name&#x27;</span>,</span><br><span class="line">    `type`                     <span class="type">VARCHAR</span>(<span class="number">20</span>)  COMMENT <span class="string">&#x27;state type&#x27;</span>,</span><br><span class="line">    `service_name`             <span class="type">VARCHAR</span>(<span class="number">128</span>) COMMENT <span class="string">&#x27;service name&#x27;</span>,</span><br><span class="line">    `service_method`           <span class="type">VARCHAR</span>(<span class="number">128</span>) COMMENT <span class="string">&#x27;method name&#x27;</span>,</span><br><span class="line">    `service_type`             <span class="type">VARCHAR</span>(<span class="number">16</span>) COMMENT <span class="string">&#x27;service type&#x27;</span>,</span><br><span class="line">    `business_key`             <span class="type">VARCHAR</span>(<span class="number">48</span>) COMMENT <span class="string">&#x27;business key&#x27;</span>,</span><br><span class="line">    `state_id_compensated_for` <span class="type">VARCHAR</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;state compensated for&#x27;</span>,</span><br><span class="line">    `state_id_retried_for`     <span class="type">VARCHAR</span>(<span class="number">50</span>) COMMENT <span class="string">&#x27;state retried for&#x27;</span>,</span><br><span class="line">    `gmt_started`              DATETIME(<span class="number">3</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;start time&#x27;</span>,</span><br><span class="line">    `is_for_update`            TINYINT(<span class="number">1</span>) COMMENT <span class="string">&#x27;is service for update&#x27;</span>,</span><br><span class="line">    `input_params`             TEXT COMMENT <span class="string">&#x27;input parameters&#x27;</span>,</span><br><span class="line">    `output_params`            TEXT COMMENT <span class="string">&#x27;output parameters&#x27;</span>,</span><br><span class="line">    `status`                   <span class="type">VARCHAR</span>(<span class="number">2</span>)   <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;status(SU succeed|FA failed|UN unknown|SK skipped|RU running)&#x27;</span>,</span><br><span class="line">    `excep`                    <span class="type">BLOB</span> COMMENT <span class="string">&#x27;exception&#x27;</span>,</span><br><span class="line">    `gmt_updated`              DATETIME(<span class="number">3</span>) COMMENT <span class="string">&#x27;update time&#x27;</span>,</span><br><span class="line">    `gmt_end`                  DATETIME(<span class="number">3</span>) COMMENT <span class="string">&#x27;end time&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`, `machine_inst_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br></pre></td></tr></table></figure>

<h5 id="TCC模式mysql-TCC模式不依赖数据源-1-4-2版本及之前-，1-4-2版本之后增加了TCC防悬挂措施，需要数据源支持。"><a href="#TCC模式mysql-TCC模式不依赖数据源-1-4-2版本及之前-，1-4-2版本之后增加了TCC防悬挂措施，需要数据源支持。" class="headerlink" title="TCC模式mysql   TCC模式不依赖数据源(1.4.2版本及之前)，1.4.2版本之后增加了TCC防悬挂措施，需要数据源支持。"></a>TCC模式mysql   TCC模式不依赖数据源(1.4.2版本及之前)，1.4.2版本之后增加了TCC防悬挂措施，需要数据源支持。</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------------------------------- The script use tcc fence  --------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `tcc_fence_log`</span><br><span class="line">(</span><br><span class="line">    `xid`           <span class="type">VARCHAR</span>(<span class="number">128</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;global id&#x27;</span>,</span><br><span class="line">    `branch_id`     <span class="type">BIGINT</span>        <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;branch id&#x27;</span>,</span><br><span class="line">    `action_name`   <span class="type">VARCHAR</span>(<span class="number">64</span>)   <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;action name&#x27;</span>,</span><br><span class="line">    `status`        TINYINT       <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;status(tried:1;committed:2;rollbacked:3;suspended:4)&#x27;</span>,</span><br><span class="line">    `gmt_create`    DATETIME(<span class="number">3</span>)   <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;create time&#x27;</span>,</span><br><span class="line">    `gmt_modified`  DATETIME(<span class="number">3</span>)   <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;update time&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`xid`, `branch_id`),</span><br><span class="line">    KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class="line">    KEY `idx_status` (`status`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line"><span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br></pre></td></tr></table></figure>



<h5 id="XA模式-XA模式只支持实现了XA协议的数据库。Seata支持MySQL、Oracle、PostgreSQL和MariDB。"><a href="#XA模式-XA模式只支持实现了XA协议的数据库。Seata支持MySQL、Oracle、PostgreSQL和MariDB。" class="headerlink" title="XA模式   XA模式只支持实现了XA协议的数据库。Seata支持MySQL、Oracle、PostgreSQL和MariDB。"></a>XA模式   XA模式只支持实现了XA协议的数据库。Seata支持MySQL、Oracle、PostgreSQL和MariDB。</h5><h2 id="四：事务分组"><a href="#四：事务分组" class="headerlink" title="四：事务分组"></a>四：事务分组</h2><ul>
<li><p>每个Seata应用侧的RM、TM，都具有一个<strong>事务分组</strong>名</p>
</li>
<li><p>每个Seata协调器侧的TC，都具有一个<strong>集群名</strong>和<strong>Seata服务地址列表</strong> 映射</p>
<p>​    应用侧连接协调器侧时，经历如下两步：</p>
<p>​    通过事务分组的名称，从配置中获取到该应用侧对应的TC集群名</p>
<p>​    过集群名称，可以从注册中心中获取TC集群的地址列表 </p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Client端配置事务分组</span></span><br><span class="line"><span class="attr">seata.tx-service-group</span>=<span class="string">$&#123;spring.application.name&#125;-tx-group</span></span><br><span class="line"><span class="comment">#Server端配置事务分组与集群的映射关系</span></span><br><span class="line"><span class="attr">service.vgroupMapping.default_tx_group</span>=<span class="string">default</span></span><br><span class="line"><span class="attr">service.vgroupMapping.seata-order-tx-group</span>=<span class="string">default</span></span><br><span class="line"><span class="attr">service.vgroupMapping.seata-store-tx-group</span>=<span class="string">default</span></span><br><span class="line"><span class="attr">service.vgroupMapping.seata-shop-tx-group</span>=<span class="string">default</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Seata集群名称是在SeataServer registry.conf配置文件中指定</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">registry <span class="punctuation">&#123;</span></span><br><span class="line">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br><span class="line">  type = <span class="string">&quot;nacos&quot;</span></span><br><span class="line">  nacos <span class="punctuation">&#123;</span></span><br><span class="line">    application = <span class="string">&quot;seata-server&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:8848&quot;</span></span><br><span class="line">    group = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">    namespace = <span class="string">&quot;7dba3cc6-3805-4f3d-b89c-0519044013b7&quot;</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    username = <span class="string">&quot;&quot;</span></span><br><span class="line">    password = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="远程服务调用XID的事务传播："><a href="#远程服务调用XID的事务传播：" class="headerlink" title="远程服务调用XID的事务传播："></a>远程服务调用XID的事务传播：</h2><p>分布在网络上的服务如何感知并加入到分布式的事务过程中呢，事务属性如何传播的呢？</p>
<p><strong>在spring-cloud-starter-alibaba-seata环境下调用方：</strong></p>
<p>Seata集成了RestTemplet 并自动配了com.alibaba.cloud.seata.SeataRestTemplateAutoConfiguration</p>
<p>Seata集成了RestTemplet 并自动配了com.alibaba.cloud.seata.feign.SeataFeignClientAutoConfiguration</p>
<p>Seata集成了hystrix 并自动配了com.alibaba.cloud.seata.feign.hystrix.SeataHystrixAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">io.seata.integration.http.TransactionPropagationIntercepter&#123;</span><br><span class="line"><span class="keyword">public</span> ClientHttpResponse <span class="title function_">intercept</span><span class="params">(HttpRequest httpRequest, <span class="type">byte</span>[] bytes, ClientHttpRequestExecution clientHttpRequestExecution)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">HttpRequestWrapper</span> <span class="variable">requestWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpRequestWrapper</span>(httpRequest);</span><br><span class="line">        <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> RootContext.getXID();</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(xid)) &#123;</span><br><span class="line">            #将TX_XID 添加到请求头</span><br><span class="line">            requestWrapper.getHeaders().add(<span class="string">&quot;TX_XID&quot;</span>, xid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clientHttpRequestExecution.execute(requestWrapper, bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">com.alibaba.cloud.seata.feign.SeataFeignClient&#123;</span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">execute</span><span class="params">(Request request, Options options)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        #修改请求头</span><br><span class="line">        <span class="type">Request</span> <span class="variable">modifiedRequest</span> <span class="operator">=</span> <span class="built_in">this</span>.getModifyRequest(request);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.delegate.execute(modifiedRequest, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Request <span class="title function_">getModifyRequest</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> RootContext.getXID();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(xid)) &#123;</span><br><span class="line">            <span class="keyword">return</span> request;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Map&lt;String, Collection&lt;String&gt;&gt; headers = <span class="keyword">new</span> <span class="title class_">HashMap</span>(<span class="number">16</span>);</span><br><span class="line">            headers.putAll(request.headers());</span><br><span class="line">            List&lt;String&gt; seataXid = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">            seataXid.add(xid);</span><br><span class="line">            #添加TX_XID到请求头</span><br><span class="line">            headers.put(<span class="string">&quot;TX_XID&quot;</span>, seataXid);</span><br><span class="line">            <span class="keyword">return</span> Request.create(request.method(), request.url(), headers, request.body(), request.charset());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在spring-cloud-starter-alibaba-seata环境下接收方：</strong></p>
<p>Seata集成了MvcHandlerInterceptor并自动配了com.alibaba.cloud.seata.SeataHandlerInterceptorConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataHandlerInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(SeataHandlerInterceptor.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeataHandlerInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> RootContext.getXID();</span><br><span class="line">        <span class="type">String</span> <span class="variable">rpcXid</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;TX_XID&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;xid in RootContext &#123;&#125; xid in RpcContext &#123;&#125;&quot;</span>, xid, rpcXid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(xid) &amp;&amp; rpcXid != <span class="literal">null</span>) &#123;</span><br><span class="line">            #从请求头中拿到TX_XID 并绑定rpcxid 达到事务传播功能</span><br><span class="line">            RootContext.bind(rpcXid);</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;bind &#123;&#125; to RootContext&quot;</span>, rpcXid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注：在seata-all包io.seata.integration中 集成了，dubbo,grpc,http,motan,sofa.rpc等事务传播功能：</strong></p>
<h2 id="事务边界定义、控制及事务状态查询（高阶api）"><a href="#事务边界定义、控制及事务状态查询（高阶api）" class="headerlink" title="事务边界定义、控制及事务状态查询（高阶api）"></a>事务边界定义、控制及事务状态查询（高阶api）</h2><h3 id="GlobalTransactionScanner-AbstractAutoProxyCreator-（注解扫描）"><a href="#GlobalTransactionScanner-AbstractAutoProxyCreator-（注解扫描）" class="headerlink" title="GlobalTransactionScanner(AbstractAutoProxyCreator),（注解扫描）"></a>GlobalTransactionScanner(AbstractAutoProxyCreator),（注解扫描）</h3><p>代理对象创建过程,对Seata目标代理对象进行分析并创建合适的植入点。确定哪些类可以做TCC,,根据目标类配置是否是TCC模式 ，确定是否植入TccActionInterceptor拦截（如类上是否有@LocalTCC），根据类上是否有@GlobalTransactional 或者方法上是否有    @GlobalTransactional 或者@GlobalLock 来确定是否植入GlobalTransactionalInterceptor。</p>
<p>TccActionInterceptor对指定@LocalTCC的类方法上有@TwoPhaseBusinessAction做拦截</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@LocalTCC</span><br><span class="line">public interface OrderTcc &#123;</span><br><span class="line">    @TwoPhaseBusinessAction(name = &quot;insertOrder&quot;,commitMethod = &quot;commit&quot;,rollbackMethod = &quot;cancel&quot;)</span><br><span class="line">    public Object insertOrder(@BusinessActionContextParameter(paramName = &quot;order&quot;) OrderInfo order);</span><br><span class="line">    public boolean commit(BusinessActionContext businessActionContext);</span><br><span class="line">    public boolean cancel(BusinessActionContext businessActionContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GlobalTransactionalInterceptor(MethodInterceptor) 提供两种模板方法，根据注解的不同使用不同的模板方法</p>
<p>​    1：TransactionalTemplate 请求全局锁，开启全局事务 模板方法</p>
<p>​        通过GlobalTransactionContext GlobalTransaction  把一个业务服务的调用包装成带有分布式事务支持的服务。</p>
<p>​    2：GlobalLockTemplate，请求全局锁</p>
<p>​        通过RootContext 把一个业务服务的调用包装全局事务锁内进行的服务。</p>
<h2 id="用于控制事务上下文的传播-低阶api"><a href="#用于控制事务上下文的传播-低阶api" class="headerlink" title="用于控制事务上下文的传播(低阶api)"></a>用于控制事务上下文的传播(低阶api)</h2><p>RootContext 事务的根上下文：负责在应用的运行时，维护 XID 。</p>
<p>高阶API 的实现都是基于 RootContext 中维护的 XID 来做的。应用的当前运行的操作是否在一个全局事务的上下文中，就是看 RootContext 中是否有 XID，RootContext 的默认实现是基于 ThreadLocal 的，即 XID 保存在当前线程上下文中</p>
<p>Seata管方文档:<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/index.html">Seata</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/19/spring/seata/" data-id="clpfb6uhr002ptoqw2gmj8p3f" data-title="Seata安装" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Seata/" rel="tag">Seata</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-db/es" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/19/db/es/" class="article-date">
  <time class="dt-published" datetime="2022-05-19T11:43:46.000Z" itemprop="datePublished">2022-05-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/DB/">DB</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/19/db/es/">ES安装与运行</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="ES安装："><a href="#ES安装：" class="headerlink" title="ES安装："></a>ES安装：</h2><p>安装 Elasticsearch 之前，你需要先安装一个较新的版本的 Java</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">Es 官网下载</a></p>
<ul>
<li><p>如果你想把 Elasticsearch 作为一个守护进程在后台运行，那么可以在后面添加参数 -d </p>
</li>
<li><p>如果你是在 Windows 上面运行 Elasticseach，你应该运行 bin\elasticsearch.bat 而不是 bin\elasticsearch</p>
</li>
</ul>
<p>测试是否安装成功</p>
<p>curl ‘<a target="_blank" rel="noopener" href="http://localhost:9200/?pretty&#39;">http://localhost:9200/?pretty&#39;</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node-222&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ryx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AaljyBfbTm2VVmOmyZSgsw&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7.15.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_flavor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;93d5a7f6192e8a1a12e154a2b81bf6fa7309da0c&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-11-04T14:04:42.515624022Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_snapshot&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lucene_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.9.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_wire_compatibility_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6.8.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_index_compatibility_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tagline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="环境变量设置："><a href="#环境变量设置：" class="headerlink" title="环境变量设置："></a>环境变量设置：</h3><p> ES_HOME=/usr/local/src/elasticsearch-7.15.2<br> ES_JAVA_HOME=/usr/local/src/elasticsearch-7.15.2/jdk</p>
<h3 id="用户组准备-es禁止使用root-启动服务，所以需要准备es对应的用户信息-创建用户组-及用户并修改es用户对根目录数据目录日志目录的权限"><a href="#用户组准备-es禁止使用root-启动服务，所以需要准备es对应的用户信息-创建用户组-及用户并修改es用户对根目录数据目录日志目录的权限" class="headerlink" title="用户组准备 es禁止使用root 启动服务，所以需要准备es对应的用户信息 创建用户组 及用户并修改es用户对根目录数据目录日志目录的权限"></a>用户组准备 es禁止使用root 启动服务，所以需要准备es对应的用户信息 创建用户组 及用户并修改es用户对根目录数据目录日志目录的权限</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">groupadd es</span><br><span class="line">useradd es -g es -p es</span><br><span class="line">chown -R es:es  elasticsearch-7.15.2/</span><br><span class="line">chown -R es:es  eslog/</span><br><span class="line">chown -R es:es  esdata/</span><br></pre></td></tr></table></figure>

<h2 id="部署配置"><a href="#部署配置" class="headerlink" title="部署配置"></a>部署配置</h2><h3 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h3><p>内存：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;64 GB 内存的机器是非常理想的， 但是32 GB 和16 GB 机器也是很常见的。少于8 GB 会适得其反（你最终需要很多很多的小机器），大于64 GB 的机器也会有问题</p>
<p>CPU:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;大多数 Elasticsearch 部署往往对 CPU 要求不高。因此，相对其它资源，具体配置多少个（CPU）不是那么关键。你应该选择具有多个内核的现代处理器，常见的集群使用两到八个核的机器。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;如果你要在更快的 CPUs 和更多的核心之间选择，选择更多的核心更好。多个内核提供的额外并发远胜过稍微快一点点的时钟频率</p>
<p>硬盘：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;硬盘对所有的集群都很重要，对大量写入的集群更是加倍重要（例如那些存储日志数据的）。硬盘是服务器上最慢的子系统，这意味着那些写入量很大的集群很容易让硬盘饱和，使得它成为集群的瓶颈。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;如果你负担得起 SSD，它将远远超出任何旋转介质（注：机械硬盘，磁带等）。 基于 SSD 的节点，查询和索引性能都有提升。如果你负担得起，SSD 是一个好的选择。</p>
<p>网络：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;快速可靠的网络显然对分布式系统的性能是很重要的。 低延时能帮助确保节点间能容易的通讯，大带宽能帮助分片移动和恢复。现代数据中心网络（1 GbE, 10 GbE）对绝大多数集群都是足够的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;即使数据中心们近在咫尺，也要避免集群跨越多个数据中心。绝对要避免集群跨越大的地理距离。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Elasticsearch 假定所有节点都是平等的—并不会因为有一半的节点在150ms 外的另一数据中心而有所不同。更大的延时会加重分布式系统中的问题而且使得调试和排错更困难</p>
<h3 id="文件描述符和MMAP"><a href="#文件描述符和MMAP" class="headerlink" title="文件描述符和MMAP"></a>文件描述符和MMAP</h3><p>Es的用户线程打开数量要求最低4096，打开文件描述符开放到65536，进程虚拟内存区域655360</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#用户级限制配置</span><br><span class="line">vi /etc/security/limits.conf   # 在最后面追加下面内容</span><br><span class="line"></span><br><span class="line">es soft nproc 4096 #max number of threads [1024] for user [es] is too low, increase to at least [4096]</span><br><span class="line">es hard nofile 65536 # elasticsearch用户拥有的可创建文件描述的权限太低，至少需要65536</span><br><span class="line">es soft nofile 65536 # elasticsearch用户拥有的可创建文件描述的权限太低，至少需要65536</span><br><span class="line"></span><br><span class="line">#切换到root用户修改 max_map_count文件包含限制一个进程可以拥有的VMA(虚拟内存区域)的数量 </span><br><span class="line">vim /etc/sysctl.conf    # 在最后面追加下面内容</span><br><span class="line">vm.max_map_count=655360</span><br><span class="line">#执行  sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="elasticsearch-相关隐私配置-elasticsearch-keystore"><a href="#elasticsearch-相关隐私配置-elasticsearch-keystore" class="headerlink" title="elasticsearch 相关隐私配置 elasticsearch-keystore"></a>elasticsearch 相关隐私配置 elasticsearch-keystore</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch-keystore create -p </span><br><span class="line"></span><br><span class="line">#设置xpack.security.transport.ssl.keystore.password</span><br><span class="line">bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password</span><br><span class="line"></span><br><span class="line">#设置xpack.security.transport.ssl.truststore.password</span><br><span class="line">bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password</span><br></pre></td></tr></table></figure>

<h3 id="管理账号密码初始"><a href="#管理账号密码初始" class="headerlink" title="管理账号密码初始"></a>管理账号密码初始</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">.bin/elasticsearch-setup-passwords interactive    </span><br><span class="line"></span><br><span class="line">Initiating the setup of passwords for reserved users elastic,kibana,logstash_system,beats_system.</span><br><span class="line">You will be prompted to enter passwords as the process progresses.</span><br><span class="line">Please confirm that you would like to continue [y/N]y</span><br><span class="line">Enter password for [elastic]: </span><br><span class="line">passwords must be at least [6] characters long</span><br><span class="line">Try again.</span><br><span class="line">Enter password for [elastic]: </span><br><span class="line">Reenter password for [elastic]: </span><br><span class="line">Passwords do not match.</span><br><span class="line">Try again.</span><br><span class="line">Enter password for [elastic]: </span><br><span class="line">Reenter password for [elastic]: </span><br><span class="line">Enter password for [kibana]: </span><br><span class="line">Reenter password for [kibana]: </span><br><span class="line">Enter password for [logstash_system]: </span><br><span class="line">Reenter password for [logstash_system]: </span><br><span class="line">Enter password for [beats_system]: </span><br><span class="line">Reenter password for [beats_system]: </span><br><span class="line">Changed password for user [kibana]</span><br><span class="line">Changed password for user [logstash_system]</span><br><span class="line">Changed password for user [beats_system]</span><br><span class="line">Changed password for user [elastic]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>系统间数据传输添加安全协议层</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">elasticsearch-certutil</span></span><br><span class="line">bin/elasticsearch-certutil</span><br><span class="line">(</span><br><span class="line">(ca [--ca-dn &lt;name&gt;] [--days &lt;n&gt;] [--pem])</span><br><span class="line">| (cert ([--ca &lt;file_path&gt;] | [--ca-cert &lt;file_path&gt; --ca-key &lt;file_path&gt;])</span><br><span class="line">[--ca-dn &lt;name&gt;] [--ca-pass &lt;password&gt;] [--days &lt;n&gt;]</span><br><span class="line">[--dns &lt;domain_name&gt;] [--in &lt;input_file&gt;] [--ip &lt;ip_addresses&gt;]</span><br><span class="line">[--keep-ca-key] [--multiple] [--name &lt;file_name&gt;] [--pem] [--self-signed])</span><br><span class="line"></span><br><span class="line">| (csr [--dns &lt;domain_name&gt;] [--in &lt;input_file&gt;] [--ip &lt;ip_addresses&gt;]</span><br><span class="line">[--name &lt;file_name&gt;])</span><br><span class="line"></span><br><span class="line">[-E &lt;KeyValuePair&gt;] [--keysize &lt;bits&gt;] [--out &lt;file_path&gt;]</span><br><span class="line">[--pass &lt;password&gt;]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">| http</span><br><span class="line"></span><br><span class="line">[-h, --help] ([-s, --silent] | [-v, --verbose])</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">The following <span class="built_in">command</span> generates a CA certificate and private key <span class="keyword">in</span> PKCS<span class="comment">#12</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生成 CA证书和私钥 以PKCS<span class="comment">#12格式存储</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">You are prompted <span class="keyword">for</span> an output filename and a password. Alternatively, you can specify the --out and --pass parameters</span></span><br><span class="line">bin/elasticsearch-certutil ca</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">You can <span class="keyword">then</span> generate X.509 certificates and private keys by using the new CA</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">You are prompted <span class="keyword">for</span> the CA password and <span class="keyword">for</span> an output filename and password. Alternatively, you can specify the --ca-pass, --out, and --pass parameters</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生成X.509 证书和私钥</span></span><br><span class="line">bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br></pre></td></tr></table></figure>



<h3 id="系统简单配置"><a href="#系统简单配置" class="headerlink" title="系统简单配置"></a>系统简单配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">ryx</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-222</span></span><br><span class="line"><span class="comment">#discovery.type: single-node</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment">#和其他程序通信</span></span><br><span class="line"><span class="attr">network.publish_host:</span> <span class="number">12.3</span><span class="number">.10</span><span class="number">.222</span></span><br><span class="line"><span class="comment">#network.publish_host: 12.3.10.205</span></span><br><span class="line"><span class="comment">#network.publish_host: 12.3.10.105</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">transport.tcp.port:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;12.3.10.222&quot;</span>,<span class="string">&quot;12.3.10.205&quot;</span>, <span class="string">&quot;12.3.10.105&quot;</span>]</span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;node-222&quot;</span>,<span class="string">&quot;node-205&quot;</span>,<span class="string">&quot;node-105&quot;</span>]</span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">2</span> <span class="comment">#至少连个master节点启动才算集群启动，并开始数据同步</span></span><br><span class="line"><span class="attr">bootstrap.system_call_filter:</span> <span class="literal">false</span> <span class="comment">#关闭系统版本校验</span></span><br><span class="line"><span class="attr">action.destructive_requires_name:</span> <span class="literal">true</span> <span class="comment">#索引删除是否名称敏感</span></span><br><span class="line"><span class="attr">action.auto_create_index:</span> <span class="literal">false</span> <span class="comment">#是否自动创建索引</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.license.self_generated.type:</span> <span class="string">basic</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">cer/elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.type:</span> <span class="string">PKCS12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.password:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span> <span class="comment">#指定传输验证模式</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">cer/elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.type:</span> <span class="string">PKCS12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>


<h3 id="重要的配置项"><a href="#重要的配置项" class="headerlink" title="重要的配置项"></a>重要的配置项</h3><ul>
<li>集群名称<br>&nbsp;&nbsp;&nbsp;&nbsp;Elasticsearch 默认启动的集群名字叫 elasticsearch 。你最好给你的生产环境的集群改个名字，改名字的目的很简单， 就是防止某人的笔记本电脑加入了集群这种意外<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#elasticsearch.yml</span><br><span class="line">cluster.name: elasticsearch_production</span><br></pre></td></tr></table></figure></li>
<li>节点名称<br>&nbsp;&nbsp;&nbsp;&nbsp;Elasticsearch 会在你的节点启动的时候随机给它指定一个名字。你可能会觉得这很有趣，但是当凌晨 3 点钟的时候， 你还在尝试回忆哪台物理机是 Tagak the Leopard Lord 的时候，你就不觉得有趣了。</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;更重要的是，这些名字是在启动的时候产生的，每次启动节点， 它都会得到一个新的名字。这会使日志变得很混乱，因为所有节点的名称都是不断变化的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#elasticsearch.yml</span><br><span class="line">node.name: elasticsearch_005_data</span><br></pre></td></tr></table></figure>


<ul>
<li>路径</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;默认情况下，Elasticsearch 会把插件、日志以及你最重要的数据放在安装目录下。这会带来不幸的事故， 如果你重新安装 Elasticsearch 的时候不小心把安装目录覆盖了。如果你不小心，你就可能把你的全部数据删掉了</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;最好的选择就是把你的数据目录配置到安装目录以外的地方， 同样你也可以选择转移你的插件和日志目录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#elasticsearch.yml</span><br><span class="line">#数据目录</span><br><span class="line">path.data: /path/to/data1,/path/to/data2 </span><br><span class="line"></span><br><span class="line">#日志目录</span><br><span class="line">path.logs: /path/to/logs</span><br><span class="line"></span><br><span class="line"># 插件目录</span><br><span class="line">path.plugins: /path/to/plugins</span><br></pre></td></tr></table></figure>
<ul>
<li>最小节点数</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;minimum_master_nodes  设定对你的集群的稳定 极其 重要。 当你的集群中有两个 masters（注：主节点）的时候，这个配置有助于防止 脑裂 ，一种两个主节点同时存在于一个集群的现象。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;如果你的集群发生了脑裂，那么你的集群就会处在丢失数据的危险中，因为主节点被认为是这个集群的最高统治者，它决定了什么时候新的索引可以创建，分片是如何移动的等等。如果你有 两个 masters 节点， 你的数据的完整性将得不到保证，因为你有两个节点认为他们有集群的控制权。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;这个配置就是告诉 Elasticsearch 当没有足够 master 候选节点的时候，就不要进行 master 节点选举，等 master 候选节点足够了才进行选举</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;此设置应该始终被配置为 master 候选节点的法定个数（大多数个）。法定个数就是 ( master 候选节点个数 / 2) + 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#elasticsearch.yml</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;persistent&quot; : &#123;</span><br><span class="line">        &quot;discovery.zen.minimum_master_nodes&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>集群恢复相关的配置</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;这三个设置可以在集群重启的时候避免过多的分片交换。这可能会让数据恢复从数个小时缩短为几秒钟</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#config/elasticsearch.yml</span><br><span class="line"># Elasticsearch 在存在至少 8 个节点（数据节点或者 master 节点）之前进行数据恢复。 这个值的设定取决于个人喜好：整个集群提供服务之前你希望有多少个节点在线？这种情况下，我们设置为 8，这意味着至少要有 8 个节点，该集群才可用</span><br><span class="line">gateway.recover_after_nodes: 8</span><br><span class="line"></span><br><span class="line"># 现在我们要告诉 Elasticsearch 集群中 应该 有多少个节点，以及我们愿意为这些节点等待多长时间</span><br><span class="line">gateway.expected_nodes: 10</span><br><span class="line">gateway.recover_after_time: 5m</span><br><span class="line">#这意味着 Elasticsearch 会采取如下操作：</span><br><span class="line">    #等待集群至少存在 8 个节点</span><br><span class="line">    #等待 5 分钟，或者10 个节点上线后，才进行数据恢复，这取决于哪个条件先达到。</span><br></pre></td></tr></table></figure>

<ul>
<li>使用单播代替组播</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Elasticsearch 默认被配置为使用单播发现，以防止节点无意中加入集群。只有在同一台机器上运行的节点才会自动组成集群。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;虽然组播仍然 作为插件提供， 但它应该永远不被使用在生产环境了，否则你得到的结果就是一个节点意外的加入到了你的生产环境，仅仅是因为他们收到了一个错误的组播信号。 对于组播 本身 并没有错，组播会导致一些愚蠢的问题，并且导致集群变的脆弱（比如，一个网络工程师正在捣鼓网络，而没有告诉你，你会发现所有的节点突然发现不了对方了）。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;使用单播，你可以为 Elasticsearch 提供一些它应该去尝试连接的节点列表。 当一个节点联系到单播列表中的成员时，它就会得到整个集群所有节点的状态，然后它会联系 master 节点，并加入集群。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;这意味着你的单播列表不需要包含你的集群中的所有节点， 它只是需要足够的节点，当一个新节点联系上其中一个并且说上话就可以了。如果你使用 master 候选节点作为单播列表，你只要列出三个就可以了。 这个配置在 elasticsearch.yml 文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">discovery.zen.ping.unicast.hosts: [&quot;host1&quot;, &quot;host2:port&quot;]</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/19/db/es/" data-id="clpfb6uhd000ptoqwek5gd08s" data-title="ES安装与运行" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ES/" rel="tag">ES</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-spring/RestTemplate" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/15/spring/RestTemplate/" class="article-date">
  <time class="dt-published" datetime="2022-05-15T10:47:55.000Z" itemprop="datePublished">2022-05-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringCloud/">SpringCloud</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/15/spring/RestTemplate/">SpringCloud负载均衡之客户端RestTemplate</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Cloud-负载均衡框架描述"><a href="#Spring-Cloud-负载均衡框架描述" class="headerlink" title="Spring Cloud 负载均衡框架描述"></a>Spring Cloud 负载均衡框架描述</h1><p>服务的治理：</p>
<p>服务治理的参与方有 服务提供方，服务消费方，注册中心，服务提供方将自己作为服务提供者注册到注册中心，服务消费方从注册中心获取订阅的服务列表，注册中心完成服务的健康检查<br>服务停止注册中心就停止租约，服务启动重新在注册中心续租。</p>
<p>客服端服务端调用：</p>
<p>客户端服务调用是在客户端持有服务列表并与注册中心保持通信，并获取注册中心的服务对应主机列表，<em><strong>然后通过请求的过程中完成客户单请求的信息重写</strong></em>，完成负载均衡功能。</p>
<h1 id="客户端调用服务端模板工具-spring-web包-RestTemplate"><a href="#客户端调用服务端模板工具-spring-web包-RestTemplate" class="headerlink" title="客户端调用服务端模板工具 spring-web包 RestTemplate"></a>客户端调用服务端模板工具 spring-web包 RestTemplate</h1><p>RestTemplate 是同步调用HTTP请求的模板方法工具类，是通过底层HTTP客户端库实现，他定义了我们请求的通用过程，是一个模板工具。支持POST GET PUT等http请求方法。并提供了不同的结构类型。如 getForEntity 返回http请求结果对象，其中包含了响应的头，响应状态等请求相关数据 getForObject 返回指定的数据类型，既将结果转化为给定的对象。其底层都调用了模板方法 doExecute.<br>执行流程为（主要分析请求创建过程及请求处理过程）</p>
<ol>
<li>完成请求创建 主要分析请求创建过程</li>
<li>请求设置</li>
<li>请求执行</li>
<li>异常处理</li>
<li>响应结果提取</li>
</ol>
<img src="/2022/05/15/spring/RestTemplate/RestTemplate.png" class="" title="类图结构">

<ol>
<li>HttpAccessor http访问器 是RestTemplate 类机构中最顶层的类，内部成员及方法如下，其包含了基本的客户端请求工厂 并包含通用的请求初始化器，对所有请求有效, 其包含了创建请求的能力，并使用请求初始器对请求进行初始化。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HttpAccessor</span> &#123;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 创建Request工厂</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">ClientHttpRequestFactory</span> <span class="variable">requestFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleClientHttpRequestFactory</span>();</span><br><span class="line"><span class="comment">//对创建的请求进行初始化</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;ClientHttpRequestInitializer&gt; clientHttpRequestInitializers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	 <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//通过 请求url method 创建请求，内部受保护的方法，底层使用 ClientHttpRequestFactory 完成request的创建</span></span><br><span class="line">	<span class="keyword">protected</span> ClientHttpRequest <span class="title function_">createRequest</span><span class="params">(URI url, HttpMethod method)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//获取工厂并完成请求创建</span></span><br><span class="line">		<span class="type">ClientHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> getRequestFactory().createRequest(url, method);</span><br><span class="line">		initialize(request);</span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;HTTP &quot;</span> + method.name() + <span class="string">&quot; &quot;</span> + url);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> request;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(ClientHttpRequest request)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.clientHttpRequestInitializers.forEach(initializer -&gt; initializer.initialize(request));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>InterceptingHttpAccessor 继承http访问器HttpAccessor  并做了扩展，持有拦截器列表，并重写了 父类的getRequestFactory 方法，此类返回的是InterceptingClientHttpRequestFactory 工厂类，并内部持有父类的 SimpleClientHttpRequestFactory</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">InterceptingHttpAccessor</span> <span class="keyword">extends</span> <span class="title class_">HttpAccessor</span> &#123;</span><br><span class="line"><span class="comment">//拦截器列表</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;ClientHttpRequestInterceptor&gt; interceptors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//拦截器工厂私有成员</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> ClientHttpRequestFactory interceptingRequestFactory;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> ClientHttpRequestFactory <span class="title function_">getRequestFactory</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">//获取拦截器</span></span><br><span class="line">		List&lt;ClientHttpRequestInterceptor&gt; interceptors = getInterceptors();</span><br><span class="line">		<span class="keyword">if</span> (!CollectionUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">			<span class="type">ClientHttpRequestFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptingRequestFactory;</span><br><span class="line">			<span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//构建请求工厂，内部持有拦截器列表</span></span><br><span class="line">				factory = <span class="keyword">new</span> <span class="title class_">InterceptingClientHttpRequestFactory</span>(<span class="built_in">super</span>.getRequestFactory(), interceptors);</span><br><span class="line">				<span class="built_in">this</span>.interceptingRequestFactory = factory;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> factory;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">super</span>.getRequestFactory();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>RestTemplate 继承http访问器InterceptingHttpAccessor ，RestTemplate默认具有拦截器能力，创建请求的能力<em><strong>重写了父类的能力</strong></em>，初始化请求的能力，<br>自带 消息转换 messageConverters 异常处理 errorHandler 结果提取能力 headersExtractor。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplate</span> <span class="keyword">extends</span> <span class="title class_">InterceptingHttpAccessor</span> <span class="keyword">implements</span> <span class="title class_">RestOperations</span>&#123;</span><br><span class="line"><span class="comment">//消息转换器列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//异常处理器</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">ResponseErrorHandler</span> <span class="variable">errorHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultResponseErrorHandler</span>();</span><br><span class="line"><span class="comment">//url处理模板</span></span><br><span class="line">	<span class="keyword">private</span> UriTemplateHandler uriTemplateHandler;</span><br><span class="line"><span class="comment">//结果提取器</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ResponseExtractor&lt;HttpHeaders&gt; headersExtractor = <span class="keyword">new</span> <span class="title class_">HeadersExtractor</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//模板方法</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">doExecute</span><span class="params">(URI url, <span class="meta">@Nullable</span> HttpMethod method, <span class="meta">@Nullable</span> RequestCallback requestCallback,<span class="meta">@Nullable</span> ResponseExtractor&lt;T&gt; responseExtractor)</span> <span class="keyword">throws</span> RestClientException &#123;</span><br><span class="line">		<span class="type">ClientHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">//创建请求命令  通过分析 createRequest 这里拿到的是 InterceptingClientHttpRequest</span></span><br><span class="line">			<span class="type">ClientHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> createRequest(url, method);</span><br><span class="line">			<span class="keyword">if</span> (requestCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">				requestCallback.doWithRequest(request);</span><br><span class="line">			&#125;</span><br><span class="line"><span class="comment">//请求执行 InterceptingClientHttpRequest.execute()</span></span><br><span class="line">			response = request.execute();</span><br><span class="line"><span class="comment">//异常处理</span></span><br><span class="line">			handleResponse(url, method, response);</span><br><span class="line"><span class="comment">//结果提取</span></span><br><span class="line">			<span class="keyword">return</span> (responseExtractor != <span class="literal">null</span> ? responseExtractor.extractData(response) : <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//创建请求命令</span></span><br><span class="line">    <span class="keyword">protected</span> ClientHttpRequest <span class="title function_">createRequest</span><span class="params">(URI url, HttpMethod method)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"><span class="comment">//调用 父类 InterceptingHttpAccessor 方法 得到 InterceptingClientHttpRequestFactory(内部持有SimpleClientHttpRequestFactory) 创建  ClientHttpRequest(InterceptingClientHttpRequest)</span></span><br><span class="line">		<span class="type">ClientHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> getRequestFactory().createRequest(url, method);</span><br><span class="line"><span class="comment">//使用HttpAccessor 方法完成初始化</span></span><br><span class="line">		initialize(request);</span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;HTTP &quot;</span> + method.name() + <span class="string">&quot; &quot;</span> + url);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> request;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RestTemplate类及父类都是通过ClientHttpRequestFactory工厂来创建请求，并在不同的父类中，工厂类有所不同，InterceptingHttpAccessor 中有ClientHttpRequestFactory (InterceptingClientHttpRequestFactory) 创建 InterceptingClientHttpRequest 有了拦截器能力，HttpAccessor中有ClientHttpRequestFactory （SimpleClientHttpRequestFactory)有通过HttpURLConnection发送http请求发送能力</p>
<img src="/2022/05/15/spring/RestTemplate/RestTemplate%E5%88%9B%E5%BB%BARequest%E8%BF%87%E7%A8%8B.jpg" class="" title="RestTemplate创建Request过程">
<blockquote>
<p>那么 ClientHttpRequestFactory 如何创建 request 并且ClientHttpRequest 是如何在执行的时候，执行拦截器，并完成最后的http请求的呢？</p>
</blockquote>
<img src="/2022/05/15/spring/RestTemplate/ClientHttpRequestFactory.png" class="" title="类图结构">

<img src="/2022/05/15/spring/RestTemplate/HttpRequest.png" class="" title="类图结构">

<h1 id="ClientHttpRequestFactory-通过URI和HttpMethod创建请求"><a href="#ClientHttpRequestFactory-通过URI和HttpMethod创建请求" class="headerlink" title="ClientHttpRequestFactory 通过URI和HttpMethod创建请求"></a>ClientHttpRequestFactory 通过URI和HttpMethod创建请求</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClientHttpRequestFactory</span> &#123;</span><br><span class="line">	ClientHttpRequest <span class="title function_">createRequest</span><span class="params">(URI uri, HttpMethod httpMethod)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *包装类， 内部持有实际工厂</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractClientHttpRequestFactoryWrapper</span> <span class="keyword">implements</span> <span class="title class_">ClientHttpRequestFactory</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ClientHttpRequestFactory requestFactory;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> ClientHttpRequest <span class="title function_">createRequest</span><span class="params">(URI uri, HttpMethod httpMethod)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"><span class="comment">//调用内部方法</span></span><br><span class="line">		<span class="keyword">return</span> createRequest(uri, httpMethod, <span class="built_in">this</span>.requestFactory);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//由子类创建请求，并将包装的工厂，传递给子类</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">abstract</span> ClientHttpRequest <span class="title function_">createRequest</span><span class="params">( URI uri, HttpMethod httpMethod, ClientHttpRequestFactory requestFactory)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 带有拦截器的工厂类</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InterceptingClientHttpRequestFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractClientHttpRequestFactoryWrapper</span> &#123;</span><br><span class="line"><span class="comment">// 拦截器列表</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;ClientHttpRequestInterceptor&gt; interceptors;</span><br><span class="line"><span class="comment">//持有包装的工厂类 和 拦截器构造方法</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">InterceptingClientHttpRequestFactory</span><span class="params">(ClientHttpRequestFactory requestFactory,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> List&lt;ClientHttpRequestInterceptor&gt; interceptors)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(requestFactory);</span><br><span class="line">		<span class="built_in">this</span>.interceptors = (interceptors != <span class="literal">null</span> ? interceptors : Collections.emptyList());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里实现了 父类 AbstractClientHttpRequestFactoryWrapper 的 createRequest 参数 requestFactory </span></span><br><span class="line"><span class="comment">//正式父类持有的包装类 也就是InterceptingClientHttpRequestFactory 构造函数传递进去的被包装的类，</span></span><br><span class="line"><span class="comment">//根据 InterceptingHttpAccessor 分析 此处被包装的类是 HttpAccessor 类中的 SimpleClientHttpRequestFactory</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> ClientHttpRequest <span class="title function_">createRequest</span><span class="params">(URI uri, HttpMethod httpMethod, ClientHttpRequestFactory requestFactory)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InterceptingClientHttpRequest</span>(requestFactory, <span class="built_in">this</span>.interceptors, uri, httpMethod);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ClientHttpRequest-完成拦截器功能及底层的http请求"><a href="#ClientHttpRequest-完成拦截器功能及底层的http请求" class="headerlink" title="ClientHttpRequest 完成拦截器功能及底层的http请求"></a>ClientHttpRequest 完成拦截器功能及底层的http请求</h1><img src="/2022/05/15/spring/RestTemplate/HTTPmessage.png" class="" title="类图结构">
<img src="/2022/05/15/spring/RestTemplate/HttpRequest.png" class="" title="类图结构">

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *通用消息定义</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HttpMessage</span> &#123;</span><br><span class="line">	HttpHeaders <span class="title function_">getHeaders</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *输出消息</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HttpOutputMessage</span> <span class="keyword">extends</span> <span class="title class_">HttpMessage</span> &#123;</span><br><span class="line">	OutputStream <span class="title function_">getBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *输入消息</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HttpInputMessage</span> <span class="keyword">extends</span> <span class="title class_">HttpMessage</span> &#123;</span><br><span class="line">	InputStream <span class="title function_">getBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *http请求</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HttpRequest</span> <span class="keyword">extends</span> <span class="title class_">HttpMessage</span> &#123;</span><br><span class="line"><span class="comment">//请求方法</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">default</span> HttpMethod <span class="title function_">getMethod</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> HttpMethod.resolve(getMethodValue());</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//请求方法</span></span><br><span class="line">	String <span class="title function_">getMethodValue</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//请求URI</span></span><br><span class="line">	URI <span class="title function_">getURI</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽象的客户端http请求 继承了 HttpRequest HttpOutputMessage 命令模式可被执行（包含http命令的内容 body 包含http headers 包含 请求方法 请求URI)</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClientHttpRequest</span> <span class="keyword">extends</span> <span class="title class_">HttpRequest</span>, HttpOutputMessage &#123;</span><br><span class="line">	ClientHttpResponse <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽象的客户端http请求 默认的抽象ClientHttpRequest实现类，持有HttpHeaders成员变量</span></span><br><span class="line"><span class="comment"> * 实现 execute 方法，生成 executeInternal抽象方法    扩展execute 新增Httpheaders参数，提供子类执行http请求必要数据</span></span><br><span class="line"><span class="comment"> * 实现 getBody 方法， 生成  getBodyInternal抽象方法  扩展getBody 新增Httpheaders参数，提供子类执行getBody请求必要数据</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractClientHttpRequest</span> <span class="keyword">implements</span> <span class="title class_">ClientHttpRequest</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">executed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> HttpHeaders <span class="title function_">getHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="built_in">this</span>.executed ? HttpHeaders.readOnlyHttpHeaders(<span class="built_in">this</span>.headers) : <span class="built_in">this</span>.headers);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> OutputStream <span class="title function_">getBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		assertNotExecuted();</span><br><span class="line">		<span class="keyword">return</span> getBodyInternal(<span class="built_in">this</span>.headers);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> ClientHttpResponse <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		assertNotExecuted();</span><br><span class="line">		<span class="type">ClientHttpResponse</span> <span class="variable">result</span> <span class="operator">=</span> executeInternal(<span class="built_in">this</span>.headers);</span><br><span class="line">		<span class="built_in">this</span>.executed = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">abstract</span> OutputStream <span class="title function_">getBodyInternal</span><span class="params">(HttpHeaders headers)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">abstract</span> ClientHttpResponse <span class="title function_">executeInternal</span><span class="params">(HttpHeaders headers)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽象的客户端http请求 实现了抽象类AbstractClientHttpRequest，持有消息体 </span></span><br><span class="line"><span class="comment"> * 实现 executeInternal 并扩展  executeInternal 除了HttpHeaders 新增bufferedOutput参数，提供子类执行http请求必要数据</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractBufferingClientHttpRequest</span> <span class="keyword">extends</span> <span class="title class_">AbstractClientHttpRequest</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">ByteArrayOutputStream</span> <span class="variable">bufferedOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>(<span class="number">1024</span>);</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> OutputStream <span class="title function_">getBodyInternal</span><span class="params">(HttpHeaders headers)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.bufferedOutput;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> ClientHttpResponse <span class="title function_">executeInternal</span><span class="params">(HttpHeaders headers)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="type">byte</span>[] bytes = <span class="built_in">this</span>.bufferedOutput.toByteArray();</span><br><span class="line"><span class="comment">//添加内容长度</span></span><br><span class="line">		<span class="keyword">if</span> (headers.getContentLength() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			headers.setContentLength(bytes.length);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">ClientHttpResponse</span> <span class="variable">result</span> <span class="operator">=</span> executeInternal(headers, bytes);</span><br><span class="line">		<span class="built_in">this</span>.bufferedOutput = <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//子类实现 此类提供请求头和请求体</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">abstract</span> ClientHttpResponse <span class="title function_">executeInternal</span><span class="params">(HttpHeaders headers, <span class="type">byte</span>[] bufferedOutput)</span><span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 客户端http请求 实现了拦截器链功能的请求 实现了抽象类AbstractBufferingClientHttpRequest，持有消息体，持有消息头，并且完成了 executeInternal实现，是一个具体可被执行的http请求</span></span><br><span class="line"><span class="comment"> *  1：执行委派给了拦截器处理链</span></span><br><span class="line"><span class="comment"> *  2：拦截器链顺序执行 拦截器列表，拦截器完成对请求对象的相关处理 如负载均衡</span></span><br><span class="line"><span class="comment"> *  3：拦截器链执行完毕后最终执行 SimpleClientHttpRequestFactory 创建请求，完成真正的请求执行</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InterceptingClientHttpRequest</span> <span class="keyword">extends</span> <span class="title class_">AbstractBufferingClientHttpRequest</span> &#123;</span><br><span class="line">    <span class="comment">//有包装工厂 InterceptingClientHttpRequestFactory 提供的  SimpleClientHttpRequestFactory</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ClientHttpRequestFactory requestFactory;</span><br><span class="line">    <span class="comment">//有包装工厂 InterceptingClientHttpRequestFactory 提供的  拦截器处理链</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;ClientHttpRequestInterceptor&gt; interceptors;</span><br><span class="line">    <span class="comment">//请求URI及请求方法</span></span><br><span class="line">	<span class="keyword">private</span> HttpMethod method;</span><br><span class="line">	<span class="keyword">private</span> URI uri;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">//具体执行委派给了处理链</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> ClientHttpResponse <span class="title function_">executeInternal</span><span class="params">(HttpHeaders headers, <span class="type">byte</span>[] bufferedOutput)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="type">InterceptingRequestExecution</span> <span class="variable">requestExecution</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterceptingRequestExecution</span>();</span><br><span class="line">		<span class="comment">//拦截器链执行 拦截器列表以此执行并最终发返回 InterceptingRequestExecution 最终的HTTP最终请求</span></span><br><span class="line">		<span class="keyword">return</span> requestExecution.execute(<span class="built_in">this</span>, bufferedOutput);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拦截器链执行器</span></span><br><span class="line"> 	<span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">InterceptingRequestExecution</span> <span class="keyword">implements</span> <span class="title class_">ClientHttpRequestExecution</span> &#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Iterator&lt;ClientHttpRequestInterceptor&gt; iterator;</span><br><span class="line">		<span class="keyword">public</span> <span class="title function_">InterceptingRequestExecution</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//处理链持有 InterceptingClientHttpRequest 中的 拦截器迭代器</span></span><br><span class="line">			<span class="built_in">this</span>.iterator = interceptors.iterator();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> ClientHttpResponse <span class="title function_">execute</span><span class="params">(HttpRequest request, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		    <span class="comment">//执行拦截器，拦截器中持有处理链，并在拦截器链中继续执行拦截器链</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.iterator.hasNext()) &#123;</span><br><span class="line">				<span class="type">ClientHttpRequestInterceptor</span> <span class="variable">nextInterceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.iterator.next();</span><br><span class="line">				<span class="keyword">return</span> nextInterceptor.intercept(request, body, <span class="built_in">this</span>);</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//处理链执行完毕执行真正的请求</span></span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="type">HttpMethod</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">                <span class="comment">//将经过一系列处理的请求，最终数据委派SimpleClientHttpRequestFactory 创建请求来执行</span></span><br><span class="line">				<span class="type">ClientHttpRequest</span> <span class="variable">delegate</span> <span class="operator">=</span> requestFactory.createRequest(request.getURI(), method);</span><br><span class="line">                <span class="comment">//将请求数据设置到委派的请求中</span></span><br><span class="line">				request.getHeaders().forEach((key, value) -&gt; delegate.getHeaders().addAll(key, value));</span><br><span class="line">				<span class="keyword">if</span> (body.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (delegate <span class="keyword">instanceof</span> StreamingHttpOutputMessage) &#123;</span><br><span class="line">						<span class="type">StreamingHttpOutputMessage</span> <span class="variable">streamingOutputMessage</span> <span class="operator">=</span> (StreamingHttpOutputMessage) delegate;</span><br><span class="line">						streamingOutputMessage.setBody(outputStream -&gt; StreamUtils.copy(body, outputStream));</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						StreamUtils.copy(body, delegate.getBody());</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> delegate.execute();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//拦截器</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClientHttpRequestInterceptor</span> &#123;</span><br><span class="line">	ClientHttpResponse <span class="title function_">intercept</span><span class="params">(HttpRequest request, <span class="type">byte</span>[] body, ClientHttpRequestExecution execution)</span><span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Request 执行过程</p>
<img src="/2022/05/15/spring/RestTemplate/InterceptingClientHttpRequestexec.jpg" class="" title="Request执行过程">
<h1 id="总-结"><a href="#总-结" class="headerlink" title="总 结"></a>总 结</h1><ol>
<li>RestTemplate 通过模板方法来控制整个执行过程</li>
<li>RestTemplate 包含了 父类 HttpAccessor (创建基础HTTP请求能力-SimpleClientHttpRequestFactory) 和 父类InterceptingHttpAccessor（创建带有拦截器功能的HTTP请求的能力-InterceptingClientHttpRequestFactory)</li>
<li>RestTemplate createRequest 使用 InterceptingClientHttpRequestFactory 创建了 InterceptingClientHttpRequest。InterceptingClientHttpRequestFactory 是一个装饰类 里边装饰了 SimpleClientHttpRequestFactory，并且持有拦截器列表，并创建InterceptingClientHttpRequest请求，InterceptingClientHttpRequest中持有了SimpleClientHttpRequestFactory，这使得InterceptingClientHttpRequest完成处理拦截器链的请求执行完成后可执行基础的HTTP请求。</li>
<li>InterceptingClientHttpRequest 内部类 InterceptingRequestExecution 使用拦截器列表迭代器，顺序执行拦截器列表，并在最后使用SimpleClientHttpRequestFactory创建请求完成基础HTTP请求</li>
</ol>
<h3 id="spring-cloud-commons-包负载均衡自动化配置"><a href="#spring-cloud-commons-包负载均衡自动化配置" class="headerlink" title="spring-cloud-commons 包负载均衡自动化配置"></a>spring-cloud-commons 包负载均衡自动化配置</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.cloud.client.loadbalancer.AsyncLoadBalancerAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.client.loadbalancer.LoadBalancerAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.client.loadbalancer.reactive.LoadBalancerBeanPostProcessorAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.client.loadbalancer.reactive.ReactorLoadBalancerClientAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.client.loadbalancer.reactive.ReactiveLoadBalancerAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.client.serviceregistry.ServiceRegistryAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.commons.httpclient.HttpClientConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.commons.util.UtilAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.configuration.CompatibilityVerifierAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.cloud.client.serviceregistry.AutoServiceRegistrationAutoConfiguration</span></span><br></pre></td></tr></table></figure>

<h3 id="spring-cloud-commons-包"><a href="#spring-cloud-commons-包" class="headerlink" title="spring-cloud-commons 包"></a>spring-cloud-commons 包</h3><p>SmartInitializingSingleton<br>LoadBalancerRequestFactory<br>LoadBalancerClient 接口<br>LoadBalancerInterceptor ClientHttpRequestInterceptor<br>RestTemplateCustomizer</p>
<h3 id="spring-web-包"><a href="#spring-web-包" class="headerlink" title="spring-web 包"></a>spring-web 包</h3><p>RestTemplate<br>ClientHttpRequestFactory<br>ClientHttpRequestInterceptor<br>HttpMessage -&gt; HttpOutputMessage -&gt;  ClientHttpRequest(HttpRequest)<br>HttpMessage -&gt; HttpInputMessage  -&gt;  ClientHttpResponse<br>HttpRequest -&gt; HttpRequestWrapper<br>UriTemplateHandler<br>RequestCallback<br>HttpMessageConverter<br>ResponseErrorHandler<br>ResponseExtractor</p>
<h3 id="spring-cloud-netflix-ribbon"><a href="#spring-cloud-netflix-ribbon" class="headerlink" title="spring-cloud-netflix-ribbon"></a>spring-cloud-netflix-ribbon</h3><p>RibbonAutoConfiguration<br>RibbonLoadBalancerClient<br>RestTemplateCustomizer<br>RibbonClientHttpRequestFactory</p>
<h3 id="SpringClientFactory-服务子容器内默认配置"><a href="#SpringClientFactory-服务子容器内默认配置" class="headerlink" title="SpringClientFactory 服务子容器内默认配置"></a>SpringClientFactory 服务子容器内默认配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringClientFactory</span> <span class="keyword">extends</span> <span class="title class_">NamedContextFactory</span>&lt;RibbonClientSpecification&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NAMESPACE</span> <span class="operator">=</span> <span class="string">&quot;ribbon&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">SpringClientFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//子容器相关类默认配置RibbonClientConfiguration 默认控制及命名空间</span></span><br><span class="line">		<span class="built_in">super</span>(RibbonClientConfiguration.class, NAMESPACE, <span class="string">&quot;ribbon.client.name&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="属性工厂"><a href="#属性工厂" class="headerlink" title="属性工厂"></a>属性工厂</h4><p>支持配置文件控制ribbon 相关元素  ILoadBalancer IPing IRule ServerList ServerListFilter</p>
<ul>
<li>从环境变量中获取相关服务  如：orderapplication.ribbon.NFLoadBalancerClassName</li>
<li>从环境变量中获取相关服务  如：orderapplication.ribbon.NFLoadBalancerPingClassName</li>
<li>从环境变量中获取相关服务  如：orderapplication.ribbon.NFLoadBalancerRuleClassName</li>
<li>从环境变量中获取相关服务  如：orderapplication.ribbon.NIWSServerListClassName</li>
<li>从环境变量中获取相关服务  如：orderapplication.ribbon.NIWSServerListFilterClassName</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertiesFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;Class, String&gt; classToProperty = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">PropertiesFactory</span><span class="params">()</span> &#123;</span><br><span class="line">		classToProperty.put(ILoadBalancer.class, <span class="string">&quot;NFLoadBalancerClassName&quot;</span>);</span><br><span class="line">		classToProperty.put(IPing.class, <span class="string">&quot;NFLoadBalancerPingClassName&quot;</span>);</span><br><span class="line">		classToProperty.put(IRule.class, <span class="string">&quot;NFLoadBalancerRuleClassName&quot;</span>);</span><br><span class="line">		classToProperty.put(ServerList.class, <span class="string">&quot;NIWSServerListClassName&quot;</span>);</span><br><span class="line">		classToProperty.put(ServerListFilter.class, <span class="string">&quot;NIWSServerListFilterClassName&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSet</span><span class="params">(Class clazz, String name)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> StringUtils.hasText(getClassName(clazz, name));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getClassName</span><span class="params">(Class clazz, String name)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.classToProperty.containsKey(clazz)) &#123;</span><br><span class="line">			<span class="type">String</span> <span class="variable">classNameProperty</span> <span class="operator">=</span> <span class="built_in">this</span>.classToProperty.get(clazz);</span><br><span class="line">            <span class="comment">//从环境变量中获取相关服务  如：orderapplication.ribbon.NFLoadBalancerClassName</span></span><br><span class="line">			<span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> environment.getProperty(name + <span class="string">&quot;.&quot;</span> + NAMESPACE + <span class="string">&quot;.&quot;</span> + classNameProperty);</span><br><span class="line">			<span class="keyword">return</span> className;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> &lt;C&gt; C <span class="title function_">get</span><span class="params">(Class&lt;C&gt; clazz, IClientConfig config, String name)</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> getClassName(clazz, name);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(className)) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Class&lt;?&gt; toInstantiate = Class.forName(className);</span><br><span class="line">				<span class="keyword">return</span> (C) SpringClientFactory.instantiateWithConfig(toInstantiate,</span><br><span class="line">						config);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown class to load &quot;</span> + className</span><br><span class="line">						+ <span class="string">&quot; for class &quot;</span> + clazz + <span class="string">&quot; named &quot;</span> + name);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="子容器相关类默认配置（RibbonClientConfiguration"><a href="#子容器相关类默认配置（RibbonClientConfiguration" class="headerlink" title="子容器相关类默认配置（RibbonClientConfiguration)"></a>子容器相关类默认配置（RibbonClientConfiguration)</h4><p>默认每个子容器都配置了Ribbon需要的组件</p>
<ul>
<li>IClientConfig  默认配置 DefaultClientConfigImpl</li>
<li>IRule  默认配置 ZoneAvoidanceRule</li>
<li>IPing  默认配置 DummyPing</li>
<li>ServerList <code>&lt;Server&gt;</code> 默认配置ConfigurationBasedServerList</li>
<li>ServerListUpdater 默认配置 PollingServerListUpdater</li>
<li>ILoadBalancer 默认配置 ZoneAwareLoadBalancer</li>
<li>ServerListFilter <code>&lt;Server&gt;</code> 默认配置 ZonePreferenceServerListFilter</li>
<li>RibbonLoadBalancerContext 默认配置 RibbonLoadBalancerContext</li>
<li>RetryHandler 默认配置 DefaultLoadBalancerRetryHandler</li>
<li>ServerIntrospector 默认配置 DefaultServerIntrospector</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RibbonClientConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Ribbon client default connect timeout.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CONNECT_TIMEOUT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Ribbon client default read timeout.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_READ_TIMEOUT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Ribbon client default Gzip Payload flag.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">DEFAULT_GZIP_PAYLOAD</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RibbonClientName</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;client&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> maybe re-instate autowired load balancers: identified by name they could be</span></span><br><span class="line">	<span class="comment">// associated with ribbon clients</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> PropertiesFactory propertiesFactory;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> IClientConfig <span class="title function_">ribbonClientConfig</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">DefaultClientConfigImpl</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultClientConfigImpl</span>();</span><br><span class="line"><span class="comment">//加载给定服务的属性</span></span><br><span class="line">		config.loadProperties(<span class="built_in">this</span>.name);</span><br><span class="line">		config.set(CommonClientConfigKey.ConnectTimeout, DEFAULT_CONNECT_TIMEOUT);</span><br><span class="line">		config.set(CommonClientConfigKey.ReadTimeout, DEFAULT_READ_TIMEOUT);</span><br><span class="line">		config.set(CommonClientConfigKey.GZipPayload, DEFAULT_GZIP_PAYLOAD);</span><br><span class="line">		<span class="keyword">return</span> config;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> IRule <span class="title function_">ribbonRule</span><span class="params">(IClientConfig config)</span> &#123;</span><br><span class="line"><span class="comment">//从配置文件中加载IRule</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.propertiesFactory.isSet(IRule.class, name)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.propertiesFactory.get(IRule.class, config, name);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">ZoneAvoidanceRule</span> <span class="variable">rule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZoneAvoidanceRule</span>();</span><br><span class="line">		rule.initWithNiwsConfig(config);</span><br><span class="line">		<span class="keyword">return</span> rule;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> IPing <span class="title function_">ribbonPing</span><span class="params">(IClientConfig config)</span> &#123;</span><br><span class="line"><span class="comment">//从配置文件中加载IRule</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.propertiesFactory.isSet(IPing.class, name)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.propertiesFactory.get(IPing.class, config, name);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DummyPing</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> ServerList&lt;Server&gt; <span class="title function_">ribbonServerList</span><span class="params">(IClientConfig config)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.propertiesFactory.isSet(ServerList.class, name)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.propertiesFactory.get(ServerList.class, config, name);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">ConfigurationBasedServerList</span> <span class="variable">serverList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurationBasedServerList</span>();</span><br><span class="line">		serverList.initWithNiwsConfig(config);</span><br><span class="line">		<span class="keyword">return</span> serverList;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> ServerListUpdater <span class="title function_">ribbonServerListUpdater</span><span class="params">(IClientConfig config)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PollingServerListUpdater</span>(config);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> ILoadBalancer <span class="title function_">ribbonLoadBalancer</span><span class="params">(IClientConfig config,</span></span><br><span class="line"><span class="params">			ServerList&lt;Server&gt; serverList, ServerListFilter&lt;Server&gt; serverListFilter,</span></span><br><span class="line"><span class="params">			IRule rule, IPing ping, ServerListUpdater serverListUpdater)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.propertiesFactory.isSet(ILoadBalancer.class, name)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.propertiesFactory.get(ILoadBalancer.class, config, name);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ZoneAwareLoadBalancer</span>&lt;&gt;(config, rule, ping, serverList,</span><br><span class="line">				serverListFilter, serverListUpdater);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> ServerListFilter&lt;Server&gt; <span class="title function_">ribbonServerListFilter</span><span class="params">(IClientConfig config)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.propertiesFactory.isSet(ServerListFilter.class, name)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.propertiesFactory.get(ServerListFilter.class, config, name);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">ZonePreferenceServerListFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZonePreferenceServerListFilter</span>();</span><br><span class="line">		filter.initWithNiwsConfig(config);</span><br><span class="line">		<span class="keyword">return</span> filter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> RibbonLoadBalancerContext <span class="title function_">ribbonLoadBalancerContext</span><span class="params">(ILoadBalancer loadBalancer,</span></span><br><span class="line"><span class="params">			IClientConfig config, RetryHandler retryHandler)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RibbonLoadBalancerContext</span>(loadBalancer, config, retryHandler);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> RetryHandler <span class="title function_">retryHandler</span><span class="params">(IClientConfig config)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultLoadBalancerRetryHandler</span>(config);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> ServerIntrospector <span class="title function_">serverIntrospector</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultServerIntrospector</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostConstruct</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preprocess</span><span class="params">()</span> &#123;</span><br><span class="line">		setRibbonProperty(name, DeploymentContextBasedVipAddresses.key(), name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/15/spring/RestTemplate/" data-id="clpfb6uhq002ltoqwd96m32zh" data-title="SpringCloud负载均衡之客户端RestTemplate" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringCloud%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" rel="tag">SpringCloud负载均衡</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-xitong/负载均衡" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/14/xitong/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" class="article-date">
  <time class="dt-published" datetime="2022-05-14T12:24:35.000Z" itemprop="datePublished">2022-05-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD/">系统性能</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/14/xitong/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">负载均衡</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>系统性能是系统提供给用户众多性能指标的混合体，最具代表性的两个指标为吞吐量，响应时间，那么负载均衡是我们增加系统吞吐量也就是系统性能的有效手段</p>
<h1 id="常用的负载均衡技术"><a href="#常用的负载均衡技术" class="headerlink" title="常用的负载均衡技术"></a>常用的负载均衡技术</h1><h2 id="技术"><a href="#技术" class="headerlink" title="技术"></a>技术</h2><ol>
<li>基于DNS的负载均衡: 在DNS中为多个地址配置同一个名字，在查询的时候将得到其中一个，从而使客服访问不同的服务器，达到负载均衡的目的。缺点：它不能区分服务器差异，也不能反应服务器状态</li>
<li>地址转换网关负载均衡: 支持负载均衡的地址转换网关，<em><strong>可以将一个外部TCP地址映射到内部多个IP地址</strong></em>，对每次TCP连接请求动态使用其中一个地址，达到负载均衡的目的</li>
<li>协议内部支持负载均衡: 有的协议内部支持与负载均衡相关的功能，如HTTP协议中的重定向功能</li>
<li>NAT(NET Address Translation 网络地址转换) 负载均衡:<em><strong>Nat将一个IP地址转换为另一个IP地址</strong></em>，一般用于未注册的内部地址与合法的，已注册的IP地址进行转换，只用于解决IP地址紧张，不想让网络外部知道内部网络结构等场合下。</li>
<li>反向代理负载均衡：正向代理服务是内部通过代理访问外部网络，通过制定代理服务，并发送请求由代理服务器发送真实请求到网络，拿到结果后返回结果给用户，那么反向代理是网络上的用户向反向代理服务器发送请求，反向代理服务器向内部服务请求结果，并最终响应给用户的代理请求。<br>那么内部服务可配置多个站点，由反向代理服务器，实现负载均衡的功能。</li>
<li>混合性负载均衡: 多个集群组成，每个集群使用不同的负载均衡技术</li>
</ol>
<h2 id="方式"><a href="#方式" class="headerlink" title="方式"></a>方式</h2><ol>
<li><em><strong>DNS 实现负载均衡</strong></em></li>
<li><em><strong>硬件负载均衡</strong></em><br>硬件负载均衡是通过专门的硬件设备来实现负载均衡功能，类似于交换机、路由器，是一个负载均衡专用的网络设备。目前业界典型的硬件负载均衡设备有两款：F5 和 A10</li>
<li><em><strong>软件负载均衡</strong></em><br>软件负载均衡，可以在普通的服务器上运行负载均衡软件，实现负载均衡功能。目前常见的有 Nginx、HAproxy、LVS</li>
</ol>
<h2 id="网络层级"><a href="#网络层级" class="headerlink" title="网络层级"></a>网络层级</h2><table>
<thead>
<tr>
<th>OSI 7层模型</th>
<th>TCP/IP 4层模型</th>
<th>层</th>
</tr>
</thead>
<tbody><tr>
<td>应用层</td>
<td>应用层</td>
<td>7层</td>
</tr>
<tr>
<td>表示层</td>
<td>应用层</td>
<td>6层</td>
</tr>
<tr>
<td>会话层</td>
<td>应用层 HTTP、 SSH、FTP、SMTP</td>
<td>5层</td>
</tr>
<tr>
<td>传输层</td>
<td>传输层 TCP/UDP(PORT)</td>
<td>4层</td>
</tr>
<tr>
<td>网络层</td>
<td>网络层 IP</td>
<td>3层</td>
</tr>
<tr>
<td>数据链路层2</td>
<td>数据链路层 MAC</td>
<td>2层</td>
</tr>
<tr>
<td>物理层</td>
<td>数据链路层</td>
<td>1层</td>
</tr>
</tbody></table>
<img src="/2022/05/14/xitong/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/2.png" class="">

<p>网络七层模型是一个标准，而非实现。网络四层模型是一个实现的应用模型。网络四层模型由七层模型简化合并而来。</p>
<img src="/2022/05/14/xitong/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/1.png" class="" title="OSI层模型">
<h3 id="7层负载均衡"><a href="#7层负载均衡" class="headerlink" title="7层负载均衡"></a>7层负载均衡</h3><p>&emsp;&emsp;七层负载均衡工作在OSI模型的应用层，应用层协议较多，常用http、radius、dns等。七层负载就可以基于这些协议来负载。这些应用层协议中会包含很多有意义的内容。比如同一个Web服务器的负载均衡，除了根据IP加端口进行负载外，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡 </p>
<h3 id="4层负载均衡"><a href="#4层负载均衡" class="headerlink" title="4层负载均衡"></a>4层负载均衡</h3><p>&emsp;&emsp;所谓四层即运输层，就是基于 IP + 端口的负载均衡，四层负载均衡工作在OSI模型的传输层，由于在传输层，只有TCP/UDP协议，这两种协议中除了包含源IP、目标IP以外，还包含源端口号及目的端口号。四层负载均衡服务器在接受到客户端请求后，以后通过修改数据包的地址信息（IP+端口号）将流量转发到应用服务器</p>
<h3 id="3层负载均衡"><a href="#3层负载均衡" class="headerlink" title="3层负载均衡"></a>3层负载均衡</h3><p>&emsp;&emsp;基于 IP 地址,和二层负载均衡类似，负载均衡服务器对外依然提供一个VIP（虚IP），但是集群中不同的机器采用不同的IP地址。当负载均衡服务器接受到请求之后，根据不同的负载均衡算法，通过IP将请求转发至不同的真实服务器</p>
<h3 id="2层负载均衡"><a href="#2层负载均衡" class="headerlink" title="2层负载均衡"></a>2层负载均衡</h3><p>&emsp;&emsp;基于 MAC 地址,负载均衡服务器对外依然提供一个VIP（虚IP），集群中不同的机器采用相同IP地址，但是机器的MAC地址不一样。当负载均衡服务器接受到请求之后，通过改写报文的目标MAC地址的方式将请求转发到目标机器实现负载均衡</p>
<h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><ul>
<li>高可用集群     优点：避免单节点故障，另一节点能迅速顶替工作</li>
<li>负载均衡集群   优点：提高负载，提高并发量</li>
<li>分布式存储集群  优点：极大提升存储容量，提高数据可用性，保证数据安全</li>
</ul>
<h1 id="常用负载均衡工具"><a href="#常用负载均衡工具" class="headerlink" title="常用负载均衡工具"></a>常用负载均衡工具</h1><h2 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h2><p>LVS（Linux Virtual Server），也就是Linux虚拟服务器, 是一个由章文嵩博士发起的自由软件项目。使用LVS技术要达到的目标是：通过LVS提供的负载均衡技术和Linux操作系统实现一个高性能、高可用的服务器群集，它具有良好可靠性、可扩展性和可操作性。从而以低廉的成本实现最优的服务性能</p>
<h3 id="LVS工作模式"><a href="#LVS工作模式" class="headerlink" title="LVS工作模式"></a>LVS工作模式</h3><ul>
<li>LVS/NAT：网络地址转换<img src="/2022/05/14/xitong/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/4.png" class=""></li>
</ul>
<p>-通过网络地址转换实现的虚拟服务器</p>
<p>-大并发访问时，调度器的性能成为瓶颈</p>
<ul>
<li>LVS/DR：直接路由</li>
</ul>
<img src="/2022/05/14/xitong/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/5.png" class="">

<p>-直接使用路由技术实现虚拟服务器</p>
<p>-节点服务器需要配置VIP，注意MAC地址广播</p>
<ul>
<li>LVS/TUN：IP隧道</li>
</ul>
<img src="/2022/05/14/xitong/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/6.png" class="">

<p>-通过隧道方式实现虚拟服务器</p>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>Nginx（发音同engine x）是一个网页服务器，它能反向代理HTTP, HTTPS, SMTP, POP3, IMAP的协议链接，以及一个负载均衡器和一个HTTP缓存。</p>
<h3 id="upstream支持的负载均衡算法"><a href="#upstream支持的负载均衡算法" class="headerlink" title="upstream支持的负载均衡算法"></a>upstream支持的负载均衡算法</h3><ul>
<li>轮询（默认）rr round robin 可以通过weight指定轮询的权重，权重越大，被调度的次数越多</li>
<li>ip_hash 根据每个请求IP进行调度，可以解决session的问题，不能使用weight</li>
<li>fair 可以根据请求页面的大小和加载时间长短进行调度，使用第三方的upstream_fair模块</li>
<li>url_hash 按请求的url的hash进行调度，从而使每个url定向到同一服务器，使用第三方的hash模块<h3 id="upstream支持的状态参数"><a href="#upstream支持的状态参数" class="headerlink" title="upstream支持的状态参数"></a>upstream支持的状态参数</h3></li>
<li>down： 暂停对该服务器的调度</li>
<li>backup: 类似于LVS Sorry Server，当所有的非backup的服务器故障时启用</li>
<li>max_fails: 请求失败的次数，默认为1</li>
<li>fail_timeout: 在经历max_fails次失败后，暂停服务的时间<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream tianyun.com &#123;</span><br><span class="line">       #ip_hash;</span><br><span class="line">       server 192.168.1.5 weight=1 max_fails=2 fail_timeout=2;</span><br><span class="line">       server 192.168.1.2 weight=2 max_fails=2 fail_timeout=2;</span><br><span class="line">       server 192.168.1.3 max_fails=2 fail_timeout=5 down;</span><br><span class="line">       server 192.168.1.4 backup;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">location  / &#123;</span><br><span class="line">     proxy_pass  http://httpservers;</span><br><span class="line">     proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当使用ip_hash时，服务器状态不可使用weight和backup</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>proxy_next_upstream：这个指令属于 http_proxy 模块的，指定后端返回什么样的异常响应时，使用另一个realserver</p>
</blockquote>
<h2 id="HAProxy"><a href="#HAProxy" class="headerlink" title="HAProxy"></a>HAProxy</h2><p>HAProxy是一个使用C语言编写的自由及开放源代码软件，其提供高可用性、负载均衡，以及基于TCP和HTTP的应用程序代理。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/14/xitong/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" data-id="clpfb6uhv003ctoqw0enw3n2e" data-title="负载均衡" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" rel="tag">负载均衡</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Knowledge/contagious/gongkaixing" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/07/Knowledge/contagious/gongkaixing/" class="article-date">
  <time class="dt-published" datetime="2022-05-07T14:12:15.000Z" itemprop="datePublished">2022-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%9F%A5%E8%AF%86/">知识</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/07/Knowledge/contagious/gongkaixing/">疯传</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="公开性-（模仿心理学-社会认同感-可观察性力量）"><a href="#公开性-（模仿心理学-社会认同感-可观察性力量）" class="headerlink" title="公开性 （模仿心理学 社会认同感 可观察性力量）"></a>公开性 （模仿心理学 社会认同感 可观察性力量）</h2><p>&emsp;&emsp;肯-西格尔（ken segall）一个广告代理公司的总监，长期与乔布斯合作，乔布斯曾对苹果图标在电脑上正放还是反着放很苦恼，他们曾就苹果公司电脑上的苹果图标如何摆放进行讨论。<br>一种情况是将苹果图标正放，当使用者打开电脑的时候看到的图标是正的，并且他们能很好的判断电脑是否是摆正的状态，而且能给用户带来极致的用户体验，这也是乔布斯追求的。但是周围的人看到的图标是返这的，这让乔布斯很是不爽，他觉得会影响苹果的品牌形象。<br>另一种情况是苹果图标是反着的。周围的的人能看到苹果的图标是正着的。后来他们决定将标志反过来放，<strong>原因就是可观察性</strong>，乔布斯发现，<strong>看到别人在做某事的时候人么也会更可能的模仿</strong>。乔布斯是站在了品牌的角度考虑了这个问题，这个设计也是苹果图片自带广告传播属性。<br>使产品风靡的另一种催化剂 <strong>公众的可视性</strong></p>
<h3 id="模仿心理学"><a href="#模仿心理学" class="headerlink" title="模仿心理学"></a>模仿心理学</h3><p>&emsp;&emsp;心里学家将这种从众的心里现象叫做<strong>社会认同感</strong></p>
<p>&emsp;&emsp;如当人们旅游到了一个陌生的城市，走在美食街道往往选择人多的餐馆作为参考，认为人多的餐馆，菜品一定不差<strong>社会认同感</strong></p>
<p>&emsp;&emsp;如咖啡师和酒保换班通常会自己往小费的罐子中投一把一元钱，或者5元钱，是同一个道理，如果罐子是空的，顾客可能认为别人都不付小费，那么自己也不会那么大方，如果罐子是装满了钱，人们则会认为别人肯定都付了小费，自己也会大方一点。<strong>社会认同感</strong></p>
<p>&emsp;&emsp;再比如每年申请肾移植的人超过10万人，那么能够移植的肾是有限的，那么排队的人只能先来后到了，那么如果一个可移植的肾要被移植那需要完成各种匹配，可移植的肾有可能会被有些人拒绝，试想一个排在100位的患者，接收到一个可移植的肾，他有可能会拒绝，社会认同效应就会浮现，因为他觉得前边有90多位患者拒绝那这个肾脏肯定不是好肾。事实上没十个肾移植的人都因此错过治疗。<strong>社会认同感</strong></p>
<p>&emsp;&emsp;从众心理甚至会影响人们选择的职业类型，曾有一些实验，在一些读MBA的学生当中采访他们对未来的憧憬，对未来的工作报复可谓五花八门，医疗改革者，旅游网站，娱乐圈，政府官员等，但是在读了1年MBA后，回答投资银行或者咨询行业的人占了2/3，当学生们读MBA期间会了解到不同的工作机会，但是从众的心里学会受到社会影响所驱使，学生不确定自己将来要做什么职业，所以他们会看别人怎么选。<strong>社会认同感</strong></p>
<blockquote>
<p>当我们想利用这种心里现象的时候，对我们要做的事情有一定的好处，比如说酒保，但是当我们被这种社会认同感所影响的时候，那会是多么可怕，甚至会影响肾病患者的治疗，行业的选择甚至将来的一生，积极的方面不说，如见到苹果电脑的设计，能使苹果产品自带广告效应，单说消极的一面，为什么人们有时候会需要这种社会认同感，或者说求助于社会认同感。</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/07/Knowledge/contagious/gongkaixing/" data-id="clpfb6uhw003jtoqwd5mo5w34" data-title="疯传" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%96%AF%E4%BC%A0/" rel="tag">疯传</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-tool/umlrg" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/10/tool/umlrg/" class="article-date">
  <time class="dt-published" datetime="2022-02-10T07:16:35.000Z" itemprop="datePublished">2022-02-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/10/tool/umlrg/">StarUml 激活</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="第一步，解包"><a href="#第一步，解包" class="headerlink" title="第一步，解包"></a>第一步，解包</h3><p><code>app.asar</code> 文件是 <code>Electron</code> 程序的主业务文件，是一种压缩格式的文件。我们需要修改的部分就被压缩在这里，具体文件位置为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\StarUML</span><br><span class="line">├─locales</span><br><span class="line">├─resources</span><br><span class="line">| └─app.asar</span><br><span class="line">└─swiftshader</span><br></pre></td></tr></table></figure>

<p><code>app.asar</code> 文件可以使用编辑器直接打开，但如果直接修改会导致程序无法正常运行，因此需要解包修改再压缩。</p>
<p>解包前需要确认您的电脑已经安装 <code>node.js</code> ，可在 <code>CMD</code> 执行以下命令，若回显版本号说明已安装，若没有安装请移步：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files&gt;node -v</span><br><span class="line">v12.18.3</span><br></pre></td></tr></table></figure>

<p>之后全局安装 <code>asar</code> 工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">npm install -g asar </span><br><span class="line">或者 </span><br><span class="line">cnpm install -g asar</span><br><span class="line"></span><br><span class="line">C:\Program Files&gt;asar -V</span><br><span class="line">v3.0.3</span><br><span class="line"></span><br><span class="line">// 出现版本号说明安装成功</span><br></pre></td></tr></table></figure>

<p>解压 <code>app.asar</code> 文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asar extract app.<span class="property">asar</span> ./asar/</span><br></pre></td></tr></table></figure>

<p>使用上面命令将 <code>app.asar</code> 解压到同级目录 <code>asar</code> 下，前提是 <code>cd</code> 到文件所在目录，并创建好 <code>asar</code> 文件</p>
<h3 id="第二步，激活"><a href="#第二步，激活" class="headerlink" title="第二步，激活"></a>第二步，激活</h3><p>解压后在 asar 目录下，找到这个文件：<code>asar\src\engine\license-manager.js</code>，使用你偏好的编辑器打开，修改其中这段代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">checkLicenseValidity () &#123;</span><br><span class="line">  this.validate().then(() =&gt; &#123;</span><br><span class="line">    setStatus(this, true)</span><br><span class="line">  &#125;, () =&gt; &#123;</span><br><span class="line">    //setStatus(this,false)  &lt;-- comment this line</span><br><span class="line">    setStatus(this, true) //&lt;-- add this line</span><br><span class="line">    //UnregisteredDialog.showDialog() &lt;-- comment this line</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意其中注释的部分，总结来看就是将 <code>false</code> 改为 <code>true</code>，再将 <code>false</code> 的后续动作注释即可。</p>
<h3 id="第三步，压缩"><a href="#第三步，压缩" class="headerlink" title="第三步，压缩"></a>第三步，压缩</h3><p>修改完成后，将修改后的内容重新打包回 <code>app.asar</code> ，使用以下命令压缩即可，其中 pack 是我前一步解压的目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asar pack asar app.asar</span><br></pre></td></tr></table></figure>

<p>注：建议在此前备份旧的 app.asar 文件，以免造成无法挽回的损失。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/10/tool/umlrg/" data-id="clpfb6uhu0039toqwhmx796nz" data-title="StarUml 激活" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/uml/" rel="tag">uml</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Knowledge/iso8601date" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/01/13/Knowledge/iso8601date/" class="article-date">
  <time class="dt-published" datetime="2022-01-13T07:21:21.000Z" itemprop="datePublished">2022-01-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%9F%A5%E8%AF%86/">知识</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/01/13/Knowledge/iso8601date/">ISO8601标准时间格式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>国际标准化组织的国际标准ISO8601是日期和时间的表示方法，全称为《数据存储和交换形式·信息交换·日期和时间的表示方法》。目前是第二版ISO8601:2000以替代第一版ISO8601:1988。</p>
<p><strong>日期表示法</strong></p>
<p>年由4位数组成，以公历公元1年为0001年，以公元前1年为0000年，公元前2年为-0001年，其他以此类推。应用其他纪年法要换算成公历，但如果发送和接受信息的双方有共同一致同意的其他纪年法，可以自行应用。</p>
<p><strong>日历日期表示法</strong></p>
<p>年为4位数，月为2位数，月中的日为2位数，例如2004年5月3日可写成2004-05-03或20040503。</p>
<p><strong>顺序日期表示法</strong></p>
<p>可以将一年内的天数直接表示，平年365天，闰年366天。如2004年5月3日可以表示为2004-157或2004157</p>
<p><strong>日历星期和日表示法</strong></p>
<p>可以用2位数表示本年内第几个日历星期，再加上一位数表示日历星期内第几天，但日历星期前要加上一个大写字母W，如2004年5月3日可写成2004-W17-3或2004W173。但2004-W011是从2004年1月5日开始的，前几天属于上年的第54个日历星期，每个日历星期从星期一开始，星期日为第7天。</p>
<p><strong>日的时间表示法</strong></p>
<p>小时、分和秒都用2位数表示，对UTC时间最后加一个大写字母Z，其他时区用实际时间加时差表示。如UTC时间下午2点30分5秒表示为14:30:05Z或143005Z，当时的北京时间表示为22:30:05+08:00或223005+0800，也可以简化成223005+08。</p>
<p><strong>日期和时间的组合表示法</strong></p>
<p>合并表示时，要在时间前面加一大写字母T，如要表示北京时间2004年5月3日下午5点30分8秒，可以写成2004-05-03T17:30:08+08:00或20040503T093008+08。</p>
<p><strong>时间段表示法</strong></p>
<p>如果要表示某一作为一段时间的时间期间，前面加一大写字母P，但时间段后都要加上相应的代表时间的大写字母。如在一年三个月五天六小时七分三十秒内，可以写成P1Y3M5DT6H7M30S。</p>
<p><strong>重复时间表示法</strong></p>
<p>前面加上一大写字母R，如要从2004年5月6日北京时间下午1点起重复半年零5天3小时，要重复3次，可以表示为R3/20040506T130000+08/P0Y6M5DT3H0M0S。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/01/13/Knowledge/iso8601date/" data-id="clpfb6uh50001toqw4u7s4bec" data-title="ISO8601标准时间格式" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A0%87%E5%87%86/" rel="tag">标准</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; 上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DB/">DB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tc/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%9F%A5%E8%AF%86/">知识</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD/">系统性能</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/">软件工程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DDD/" rel="tag">DDD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Design/" rel="tag">Design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES/" rel="tag">ES</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/" rel="tag">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Seata/" rel="tag">Seata</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" rel="tag">SpringCloud负载均衡</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activity/" rel="tag">activity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arthas/" rel="tag">arthas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">jvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/" rel="tag">openssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oracle/" rel="tag">oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/questions/" rel="tag">questions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springmvc/" rel="tag">springmvc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/" rel="tag">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uml/" rel="tag">uml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%8F%91%E6%96%B9%E6%B3%95/" rel="tag">开发方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%87%E5%87%86/" rel="tag">标准</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%96%AF%E4%BC%A0/" rel="tag">疯传</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" rel="tag">负载均衡</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%87%E7%A8%8B%E6%A8%A1%E5%9E%8B/" rel="tag">过程模型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" rel="tag">项目管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6/" rel="tag">项目管理相关文件</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/DDD/" style="font-size: 10px;">DDD</a> <a href="/tags/Design/" style="font-size: 12.5px;">Design</a> <a href="/tags/Docker/" style="font-size: 12.5px;">Docker</a> <a href="/tags/ES/" style="font-size: 15px;">ES</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Seata/" style="font-size: 12.5px;">Seata</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/SpringCloud%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size: 10px;">SpringCloud负载均衡</a> <a href="/tags/activity/" style="font-size: 12.5px;">activity</a> <a href="/tags/arthas/" style="font-size: 10px;">arthas</a> <a href="/tags/java/" style="font-size: 12.5px;">java</a> <a href="/tags/jvm/" style="font-size: 20px;">jvm</a> <a href="/tags/linux/" style="font-size: 12.5px;">linux</a> <a href="/tags/openssl/" style="font-size: 12.5px;">openssl</a> <a href="/tags/oracle/" style="font-size: 10px;">oracle</a> <a href="/tags/questions/" style="font-size: 10px;">questions</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/spring/" style="font-size: 17.5px;">spring</a> <a href="/tags/springmvc/" style="font-size: 17.5px;">springmvc</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/uml/" style="font-size: 10px;">uml</a> <a href="/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/tags/%E5%BC%80%E5%8F%91%E6%96%B9%E6%B3%95/" style="font-size: 10px;">开发方法</a> <a href="/tags/%E6%A0%87%E5%87%86/" style="font-size: 10px;">标准</a> <a href="/tags/%E7%96%AF%E4%BC%A0/" style="font-size: 10px;">疯传</a> <a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size: 10px;">负载均衡</a> <a href="/tags/%E8%BF%87%E7%A8%8B%E6%A8%A1%E5%9E%8B/" style="font-size: 10px;">过程模型</a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" style="font-size: 12.5px;">项目管理</a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6/" style="font-size: 10px;">项目管理相关文件</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">十一月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/11/26/softwareeng/DDD/">保持模型的完整性</a>
          </li>
        
          <li>
            <a href="/2023/11/25/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E6%96%B9%E6%B3%95%E4%B9%8BRUP/">软件过程模型之RUP</a>
          </li>
        
          <li>
            <a href="/2022/08/31/db/oracl/sqlanalysi/">ORACLE sql 分析</a>
          </li>
        
          <li>
            <a href="/2022/08/26/java/arthas/">vmtoll</a>
          </li>
        
          <li>
            <a href="/2022/07/26/db/mysql/">Mysql数据类型</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 晓<br>
      Powered by <a href="https://hexo.io/" target="_blank">晓</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about/me" class="mobile-nav-link">关于</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>